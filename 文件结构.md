# LeafletGISElements 项目文件结构

## 总体结构

```
LeafletGISElements/
├── leaflet_gis_elements/       # Python模块包（Flask应用）
│   ├── __init__.py             # 应用工厂函数
│   ├── config.py               # 配置类定义
│   ├── views/                  # 视图蓝图模块
│   │   ├── __init__.py         # 蓝图导出
│   │   └── main.py             # 主路由视图
│   ├── errors/                 # 错误处理模块
│   │   ├── __init__.py         # 错误处理导出
│   │   └── handlers.py         # 错误处理器
│   └── utils/                  # 工具函数模块（预留扩展）
│       └── __init__.py
│
├── static/                     # 静态资源目录（可独立使用）
│   ├── js/                     # JavaScript模块
│   │   ├── index.js            # 模块加载器（统一入口）
│   │   ├── drag-elements.js   # 全局API导出
│   │   ├── map-controller.js  # 地图控制器（管理所有控件）
│   │   ├── style-registry.js  # 样式注册器
│   │   │
│   │   ├── core/               # 核心基础类
│   │   │   ├── constants.js          # 全局常量配置
│   │   │   ├── base-control.js       # 控件基类（拖拽、位置保存）
│   │   │   ├── stylable-control.js   # 可样式化控件基类
│   │   │   ├── map-exporter.js       # 地图导出器
│   │   │   └── utils/                # 工具函数
│   │   │       ├── coordinate.js     # 坐标转换工具
│   │   │       ├── storage.js        # 本地存储工具
│   │   │       └── draggable.js      # 通用拖动管理器（DraggableManager, ResizableManager）
│   │   │
│   │   ├── controls/           # 控件实现（按功能分类）
│   │   │   ├── legend/         # 图例控件
│   │   │   │   └── legend-control.js
│   │   │   ├── scale-bar/      # 比例尺控件
│   │   │   │   └── scale-bar-control.js
│   │   │   ├── north-arrow/    # 指北针控件
│   │   │   │   └── north-arrow-control.js
│   │   │   ├── graticule/      # 经纬度格网控件
│   │   │   │   ├── graticule-control.js       # 格网主控件
│   │   │   │   ├── graticule-style-panel.js   # 样式配置面板
│   │   │   │   └── README.md                  # 格网使用文档
│   │   │   └── export/         # 地图导出控件
│   │   │       └── export-control.js
│   │   │
│   │   ├── styles/             # 样式定义（模块化）
│   │   │   ├── north-arrow/    # 指北针样式
│   │   │   │   ├── style-gis.js       # GIS简约风格
│   │   │   │   ├── style-leaflet.js   # Leaflet经典风格
│   │   │   │   ├── style-compact.js   # 简洁指针风格
│   │   │   │   └── style-compass.js   # 罗盘风格
│   │   │   ├── scale-bar/      # 比例尺样式
│   │   │   │   ├── style-leaflet.js   # Leaflet经典风格
│   │   │   │   ├── style-gis.js       # GIS经典风格
│   │   │   │   ├── style-minimal.js   # 简约线条风格
│   │   │   │   ├── style-double.js    # 双行对比风格
│   │   │   │   └── style-striped.js   # GIS专业风格（棋盘格，默认）
│   │   │   ├── legend/         # 图例样式
│   │   │   │   ├── style-gis.js       # GIS经典风格
│   │   │   │   └── style-modern.js    # 现代风格
│   │   │   └── graticule/      # 格网样式
│   │   │       ├── style-simple.js    # 简单样式
│   │   │       └── style-dense.js     # 密集样式
│   │   │
│   │   └── README.md           # JavaScript模块使用文档
│   │
│   └── css/                    # CSS样式（原子化设计）
│       ├── main.css            # 主入口文件（导入所有样式）
│       │
│       ├── base/               # 基础样式
│       │   ├── variables.css   # CSS变量定义
│       │   └── reset.css       # CSS重置样式
│       │
│       ├── layout/             # 布局样式
│       │   ├── map.css         # 地图容器布局
│       │   └── panel.css       # 控制面板布局
│       │
│       ├── components/         # 通用组件样式
│       │   ├── buttons.css     # 按钮样式
│       │   ├── forms.css       # 表单样式
│       │   ├── notifications.css # 通知样式
│       │   └── scrollbar.css   # 滚动条样式
│       │
│       ├── controls/           # 控件特定样式
│       │   ├── scale-bar-themes.css      # 比例尺主题（使用CSS变量）
│       │   ├── legend-themes.css         # 图例主题（使用CSS变量）
│       │   ├── export-styles.css         # 导出控件样式
│       │   ├── graticule-styles.css      # 格网控件样式
│       │   └── graticule-style-panel.css # 格网配置面板样式
│       │
│       ├── utilities/          # 工具样式
│       │   ├── animations.css  # 动画定义
│       │   ├── responsive.css  # 响应式设计
│       │   └── print.css       # 打印样式
│       │
│       └── README.md           # CSS模块使用文档
│
├── templates/                  # HTML模板目录
│   ├── demo.html               # 演示页面（主页）
│   ├── 404.html                # 404错误页面
│   └── 500.html                # 500错误页面
│
├── app.py                      # Flask应用启动文件
├── setup.py                    # Python包安装配置
├── MANIFEST.in                 # 包文件清单
├── requirements.txt            # Python依赖列表
├── .gitignore                  # Git忽略文件配置
│
├── README.md                   # 项目说明文档（中英双语）
├── INTEGRATION.md              # 集成指南（详细）
├── 文件结构.md                 # 文件结构说明（本文件）
└── 任务.md                     # 开发任务记录
```

## 模块说明

### 1. Python模块（`leaflet_gis_elements/`）

Flask应用模块，采用**应用工厂模式**和**蓝图架构**。

#### 核心文件
- `__init__.py` - 应用工厂函数，创建和配置Flask应用
- `config.py` - 配置类（开发/生产/测试环境）
- `views/main.py` - 主路由蓝图
- `errors/handlers.py` - 错误处理器（404, 500等）

#### 设计特点
- ✅ 高度解耦，易于集成到其他Flask项目
- ✅ 支持多环境配置
- ✅ 蓝图化路由管理

### 2. JavaScript模块（`static/js/`）

前端JavaScript模块，采用**模块化设计**和**单一职责原则**。

#### 加载顺序
```
index.js (加载器)
  ↓
core/constants.js (全局常量配置)
  ↓
core/utils/* (工具类：storage, coordinate, draggable)
  ↓
style-registry.js (样式注册器)
  ↓
core/base-control.js (控件基类)
  ↓
styles/*/* (样式定义)
  ↓
controls/*/* (控件实现)
  ↓
map-controller.js (主控制器)
  ↓
drag-elements.js (统一API)
```

#### 核心模块

**1. 核心基础类（`core/`）**
- `constants.js` - 全局常量配置（拖动阈值、Z-Index、颜色等）
- `base-control.js` - 提供拖拽、位置保存等基础功能
- `stylable-control.js` - 提供样式切换能力
- `map-exporter.js` - 地图导出功能
- `utils/` - 工具函数
  - `coordinate.js` - 坐标转换工具
  - `storage.js` - 本地存储工具
  - `draggable.js` - 通用拖动管理器（DraggableManager, ResizableManager）

**2. 控件实现（`controls/`）**
每个控件独立目录，包含：
- 控件主类（继承自基类）
- 相关配置面板（如需要）
- 使用文档

**3. 样式定义（`styles/`）**
按控件类型分类，每个样式独立文件，通过`StyleRegistry`注册。

**4. 统一入口（`drag-elements.js`）**
提供全局`LeafletGISElements`对象，暴露所有公共API。

#### 设计特点
- ✅ 模块化加载，支持按需引入
- ✅ 单一职责，每个文件功能明确
- ✅ 继承体系清晰，易于扩展
- ✅ 统一API接口，使用简单

### 3. CSS样式（`static/css/`）

CSS样式模块，采用**原子化设计**和**主题分离**。

#### 层级结构
```
main.css (入口)
  ↓
base/ (基础层)
  ├── variables.css (CSS变量)
  └── reset.css (重置)
  ↓
layout/ (布局层)
  ├── map.css
  └── panel.css
  ↓
components/ (组件层)
  ├── buttons.css
  ├── forms.css
  └── ...
  ↓
controls/ (控件层)
  ├── scale-bar-themes.css
  ├── legend-themes.css
  └── ...
  ↓
utilities/ (工具层)
  ├── animations.css
  ├── responsive.css
  └── print.css
```

#### 设计特点
- ✅ CSS变量统一管理样式参数
- ✅ 原子化拆分，高度复用
- ✅ 主题分离，易于自定义
- ✅ 按需引入，灵活组合

### 4. 模板文件（`templates/`）

HTML模板文件，使用Jinja2模板引擎。

- `demo.html` - 完整功能演示页面
- `404.html` - 404错误页面
- `500.html` - 500错误页面

### 5. 配置文件

- `app.py` - 应用启动入口
- `setup.py` - Python包安装配置（支持pip install）
- `requirements.txt` - Python依赖清单
- `MANIFEST.in` - 包含静态文件到发布包
- `.gitignore` - Git版本控制忽略规则

### 6. 文档文件

- `README.md` - 项目总览和快速开始
- `INTEGRATION.md` - 详细集成指南
- `文件结构.md` - 本文件，详细结构说明
- `任务.md` - 开发任务记录

## 使用方式

### 方式一：作为完整Flask应用

```bash
python app.py
# 访问 http://localhost:5000
```

### 方式二：作为Python包安装

```bash
pip install .
```

```python
from leaflet_gis_elements import create_app
app = create_app('production')
```

### 方式三：集成蓝图到现有Flask项目

```python
from leaflet_gis_elements.views import main_bp
app.register_blueprint(main_bp, url_prefix='/map')
```

### 方式四：仅使用前端模块

复制`static/`目录到你的项目：

```html
<link rel="stylesheet" href="/static/css/main.css">
<script src="/static/js/index.js"></script>
```

## 扩展开发

### 添加新控件

1. 在`static/js/controls/`创建新目录
2. 实现控件类（继承`BaseControl`或`StylableControl`）
3. 在`static/js/index.js`添加加载顺序
4. 在`map-controller.js`注册控件
5. 添加对应CSS样式（可选）

### 添加新样式

1. 在`static/js/styles/[控件类型]/`创建样式文件
2. 使用`StyleRegistry.register()`注册
3. 在`static/js/index.js`添加加载顺序
4. 在`static/css/controls/`添加CSS主题（可选）

### 自定义主题

修改`static/css/base/variables.css`中的CSS变量：

```css
:root {
    --primary-color: #your-color;
    --radius-md: 8px;
    /* ... */
}
```

## 设计原则

### Python后端
1. **应用工厂模式** - 便于测试和多实例
2. **蓝图架构** - 模块化路由管理
3. **配置分离** - 多环境支持

### JavaScript前端
1. **单一职责** - 每个文件只负责一个功能
2. **继承复用** - 基类提供通用功能
3. **依赖注入** - 通过参数传递依赖
4. **事件驱动** - 松耦合组件通信

### CSS样式
1. **变量优先** - CSS变量统一管理
2. **原子化** - 样式细粒度拆分
3. **主题分离** - 主题与功能分离
4. **移动优先** - 响应式设计

## 依赖关系

### Python依赖
```
Flask >= 2.0.0
```

### JavaScript依赖
```
Leaflet >= 1.9.4 (必需)
```

### 浏览器要求
- Chrome/Edge >= 90
- Firefox >= 88
- Safari >= 14
- 支持ES6+和CSS变量

## 许可证

MIT License

## 更新日志

### v1.1.0 (2025-10-28)
- ✅ **代码重构优化** - JavaScript代码模块化提升
  - 创建通用拖动管理器 `DraggableManager` 和 `ResizableManager`
  - 创建全局常量配置文件 `constants.js`
  - 重构 `GraticuleControl` 使用新的拖动工具
  - 重构 `ExportControl` 使用新的拖动工具
  - **删除约450行重复代码**
  - 提升代码可维护性和一致性
- ✅ **模块加载优化** - 更新 `index.js` 加载顺序
  - 优先加载常量配置
  - 确保工具类在控件之前加载
- ✅ **文档更新** - 更新文件结构文档

### v1.0.1 (2025-10-28)
- ✅ 清理CSS重复样式
- ✅ 删除旧版styles.css单文件
- ✅ 删除legend-styles.css和scale-bar-styles.css（保留使用CSS变量的themes版本）
- ✅ 统一使用main.css作为唯一入口

### v1.0.0 (2025-10-28)
- ✅ 完成项目重构
- ✅ 实现模块化架构
- ✅ 原子化CSS设计
- ✅ 统一API接口
- ✅ 完善文档体系
