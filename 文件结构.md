# Leaflet GIS Elements - 文件结构

本文档记录项目的完整文件结构，便于快速定位和理解代码组织。

## 📁 项目根目录

```
leaflet-gis-elements/
├── dist/                          # 构建输出目录
├── docs/                          # 文档目录
├── examples/                      # 示例和演示
├── test/src/                      # 源代码目录
├── node_modules/                  # 依赖包
├── package.json                   # 项目配置
├── webpack.config.js              # Webpack 构建配置
├── postcss.config.js              # PostCSS 配置
├── README.md                      # 项目说明
├── LICENSE                        # 开源协议
├── MANIFEST.in                    # Python 打包清单
└── 文件结构.md                    # 本文件
```

---

## 📦 dist/ - 构建产物

构建后的发布文件，供 npm 发布和 CDN 引用。

```
dist/
├── leaflet-gis-elements.js           # 开发版 JS（未压缩）
├── leaflet-gis-elements.min.js       # 生产版 JS（压缩）
├── leaflet-gis-elements.min.js.map   # JS Source Map
├── leaflet-gis-elements.css          # 开发版 CSS（未压缩）
├── leaflet-gis-elements.min.css      # 生产版 CSS（压缩）
├── leaflet-gis-elements.min.css.map  # CSS Source Map
└── leaflet-gis-elements.d.ts         # TypeScript 类型定义文件
```

---

## 📚 docs/ - 文档

```
docs/
├── TYPES.md               # API 类型注解文档（供 AI 和开发者阅读）
├── 任务.md                 # 项目任务和待办事项
├── UI改进说明.md          # UI改进详细说明（2025-10-30）
└── 智能折叠功能说明.md    # 智能折叠功能使用指南
```

### 文件说明

- **TYPES.md**: 完整的 API 类型定义和使用说明，包含所有控件的接口、方法、事件等
- **任务.md**: 开发任务列表和进度跟踪
- **UI改进说明.md**: 2025-10-30 UI改进的详细技术说明，包括智能折叠、现代化设计等
- **智能折叠功能说明.md**: 面向用户的智能折叠功能使用指南

---

## 🎨 examples/ - 示例演示

```
examples/
├── index.html             # 主演示页面
├── js/
│   ├── config.js         # 演示配置
│   ├── demo.js           # 演示主逻辑
│   └── ui-controller.js  # UI 控制器
└── styles/
    └── main.css          # 演示页面样式
```

### 文件说明

- **index.html**: 完整的演示页面，展示所有控件功能
  - ✨ 2025-10-30: 清理内联样式，改用CSS类，代码更简洁
- **config.js**: 地图配置、图层配置等
- **demo.js**: 控件初始化和交互逻辑
- **ui-controller.js**: 演示页面的 UI 交互控制
  - ✨ 2025-10-30: 新增智能折叠功能，控件禁用时自动隐藏设置
  - 新增方法：`_toggleSettingsPanel()`, `_wrapSettingsInContainer()`, `_initializeSettingsState()`
- **main.css**: 演示页面的自定义样式
  - ✨ 2025-10-30: 全面UI升级，现代化渐变设计
  - 新增类：`.section-collapsed`, `.export-section`, `.tips-section`, `.export-buttons` 等

---

## 💻 test/src/ - 源代码

### 🎯 核心入口

```
test/src/
├── index.js       # 主入口文件，导出所有模块
└── index.d.ts     # TypeScript 类型定义文件
```

---

### 📂 test/src/js/ - JavaScript 模块

#### 🏗️ 基础类 (base/)

```
test/src/js/base/
├── base-control.js       # 基础控件类 (BaseControl)
└── stylable-control.js   # 可样式化控件类 (StylableControl)
```

**说明:**
- `BaseControl`: 所有 GIS 控件的基类，提供通用功能
- `StylableControl`: 继承 BaseControl，添加样式切换能力

---

#### 🎛️ 控件实现 (controls/)

```
test/src/js/controls/
├── north-arrow/
│   └── north-arrow-control.js     # 指北针控件
├── scale-bar/
│   └── scale-bar-control.js       # 比例尺控件
├── legend/
│   └── legend-control.js          # 图例控件
├── graticule/
│   └── graticule-control.js       # 经纬网控件
├── map-info/
│   └── map-info-control.js        # 地图注记控件
└── export-preview/
    └── export-preview-control.js  # 导出预览控件
```

**各控件说明:**

| 控件     | 文件                        | 功能                           |
| -------- | --------------------------- | ------------------------------ |
| 指北针   | `north-arrow-control.js`    | 显示地图方向，支持多种样式     |
| 比例尺   | `scale-bar-control.js`      | 显示地图比例尺，支持公制/英制  |
| 图例     | `legend-control.js`         | 显示图层图例，支持多图层       |
| 经纬网   | `graticule-control.js`      | 绘制经纬网格，支持自定义间隔   |
| 地图注记 | `map-info-control.js`       | 显示地图元数据（标题、作者等） |
| 导出预览 | `export-preview-control.js` | 导出地图为图片                 |

---

#### 🎨 样式定义 (styles/)

```
test/src/js/styles/
├── north-arrow/
│   ├── style-compact.js     # 紧凑型指北针
│   ├── style-compass.js     # 罗盘型指北针
│   ├── style-gis.js         # GIS 专业型指北针
│   └── style-leaflet.js     # Leaflet 原生风格
├── scale-bar/
│   ├── style-double.js      # 双行比例尺
│   ├── style-gis.js         # GIS 专业比例尺
│   ├── style-leaflet.js     # Leaflet 原生比例尺
│   └── style-minimal.js     # 极简比例尺
├── legend/
│   ├── style-gis.js         # GIS 专业图例
│   └── style-modern.js      # 现代图例
├── graticule/
│   ├── style-simple.js      # 简单经纬网
│   └── style-dense.js       # 密集经纬网
├── map-info/
│   ├── style-compact.js     # 紧凑型注记
│   └── style-professional.js # 专业型注记
└── export-preview/
    └── style-default.js     # 默认导出样式
```

**样式系统说明:**
- 每个控件可以有多个预设样式
- 样式文件导出 `render()` 函数，返回 HTML 字符串
- 通过 StyleRegistry 统一管理和注册

---

#### 🎮 控制器 (controllers/)

```
test/src/js/controllers/
├── map-controller.js    # 地图控制器，统一管理多个控件
└── style-registry.js    # 样式注册器，管理所有样式
```

**说明:**
- `MapController`: 集中管理所有 GIS 控件的生命周期
- `StyleRegistry`: 全局样式注册和获取，支持自定义样式

---

#### 📤 导出功能 (export/)

```
test/src/js/export/
├── map-exporter.js        # 地图导出核心逻辑
├── export-config.js       # 导出配置常量
├── bounds-calculator.js   # 边界计算器
└── svg-fixer.js          # SVG 修复工具（解决导出问题）
```

**说明:**
- `MapExporter`: 使用 html2canvas 导出地图为图片
- `BoundsCalculator`: 计算导出区域范围
- `SVGFixer`: 修复 SVG 元素的导出问题

---

#### 🛠️ 工具函数 (utils/)

```
test/src/js/utils/
├── coordinate.js    # 坐标格式化工具（DMS、DD 等）
├── draggable.js     # 拖拽功能实现
├── notification.js  # 消息通知工具
└── storage.js       # 本地存储工具
```

**各工具说明:**

| 工具       | 文件              | 功能                               |
| ---------- | ----------------- | ---------------------------------- |
| 坐标格式化 | `coordinate.js`   | 转换坐标格式（度分秒、十进制度等） |
| 拖拽       | `draggable.js`    | 为元素添加拖拽能力                 |
| 通知       | `notification.js` | 显示成功/错误/警告消息             |
| 存储       | `storage.js`      | localStorage 封装，保存控件位置等  |

---

#### 📋 常量定义

```
test/src/js/
└── constants.js     # 全局常量定义
```

**说明:** 定义控件类型、默认配置等常量

---

### 🎨 test/src/css/ - 样式文件

#### 📐 基础样式 (base/)

```
test/src/css/base/
├── variables.css       # CSS 变量定义（颜色、字体、间距等）
└── control-base.css    # 控件基础样式
```

---

#### 🎛️ 控件样式 (controls/)

```
test/src/css/controls/
├── north-arrow-styles.css   # 指北针样式（已在 JS 中内联）
├── scale-bar-styles.css     # 比例尺样式
├── legend-styles.css        # 图例样式
├── graticule-styles.css     # 经纬网样式
└── map-info-styles.css      # 地图注记样式
```

**注意:** 部分控件样式由 JS 动态生成，CSS 文件作为备用或基础样式。

---

#### 🛠️ 工具样式 (utilities/)

```
test/src/css/utilities/
├── animations.css    # 动画效果
├── helpers.css       # 辅助类（显示/隐藏等）
├── print.css         # 打印样式
└── responsive.css    # 响应式样式
```

---

#### 📌 样式入口

```
test/src/css/
├── controls.css      # 控件样式汇总入口
└── README.md         # CSS 架构说明
```

---

## 🔧 配置文件

### package.json

```json
{
  "main": "dist/leaflet-gis-elements.js",           // CommonJS 入口
  "types": "dist/leaflet-gis-elements.d.ts",        // TypeScript 类型定义
  "typings": "dist/leaflet-gis-elements.d.ts",      // TypeScript 类型定义（备用）
  "unpkg": "dist/leaflet-gis-elements.min.js",      // CDN 入口
  "jsdelivr": "dist/leaflet-gis-elements.min.js",   // CDN 入口
  "style": "dist/leaflet-gis-elements.css"          // 样式文件
}
```

### webpack.config.js

- **入口**: `test/src/index.js`
- **输出**: `dist/leaflet-gis-elements[.min].js`
- **CSS 提取**: 使用 MiniCssExtractPlugin
- **PostCSS**: 自动添加 `.leaflet-gis-elements` 前缀
- **类型文件**: 自动复制 `test/src/index.d.ts` 到 `dist/`

### postcss.config.js

- 使用 `postcss-prefix-selector` 为样式添加命名空间
- 避免样式冲突

---

## 📊 模块依赖关系

```
index.js
├── constants.js
├── controllers/
│   ├── map-controller.js
│   └── style-registry.js
├── controls/
│   ├── north-arrow-control.js → base-control.js → stylable-control.js
│   ├── scale-bar-control.js → base-control.js → stylable-control.js
│   ├── legend-control.js → base-control.js → stylable-control.js
│   ├── graticule-control.js → base-control.js
│   ├── map-info-control.js → base-control.js → stylable-control.js
│   └── export-preview-control.js → base-control.js
├── styles/
│   ├── north-arrow/ → style-registry.js
│   ├── scale-bar/ → style-registry.js
│   ├── legend/ → style-registry.js
│   ├── graticule/ → style-registry.js
│   ├── map-info/ → style-registry.js
│   └── export-preview/ → style-registry.js
├── export/
│   ├── map-exporter.js → bounds-calculator.js, svg-fixer.js
│   ├── export-config.js
│   └── bounds-calculator.js
└── utils/
    ├── coordinate.js
    ├── draggable.js
    ├── notification.js
    └── storage.js
```

---

## 🎯 快速查找指南

### 要修改控件功能？

查看 `test/src/js/controls/<控件名>/` 目录

### 要添加新样式？

1. 在 `test/src/js/styles/<控件名>/` 创建样式文件
2. 在控件初始化时注册样式

### 要修改控件外观？

查看 `test/src/css/controls/<控件名>-styles.css`

### 要调整全局配置？

查看 `test/src/js/constants.js`

### 要了解 API？

查看 `docs/TYPES.md` 或 `test/src/index.d.ts`

### 要运行示例？

打开 `examples/index.html` 或运行 `npm run serve`

---

## 🔄 构建流程

```
1. npm run build
   ↓
2. Webpack 读取 test/src/index.js
   ↓
3. 编译 JS 和 CSS
   ↓
4. PostCSS 处理样式（添加前缀）
   ↓
5. 压缩 JS 和 CSS
   ↓
6. 复制 test/src/index.d.ts 到 dist/
   ↓
7. 生成 Source Maps
   ↓
8. 输出到 dist/ 目录
```

---

## 📝 开发建议

### 代码组织原则

1. **原子化**: 每个模块尽可能独立，职责单一
2. **通用化**: 代码解耦，易于复用和测试
3. **分层**: base → controls → styles，清晰的继承关系

### 文件命名规范

- **控件**: `<name>-control.js`
- **样式**: `style-<name>.js`
- **工具**: `<name>.js`（小写，连字符）

### 新增控件步骤

1. 在 `test/src/js/controls/` 创建目录
2. 继承 `BaseControl` 或 `StylableControl`
3. 在 `test/src/js/styles/` 创建样式
4. 在 `test/src/index.js` 导出
5. 在 `test/src/css/controls/` 添加样式（可选）
6. 更新 `docs/TYPES.md` 和 `test/src/index.d.ts`
7. 更新本文件

---

## 📌 更新记录

- **2024-10-30**: 源代码目录从 `src/` 迁移至 `test/src/`，更新所有文档引用
- **2024-10-30**: 修复示例代码兼容性问题，在 `export-preview-control.js` 中添加 `autoCalculateExportBounds()` 和 `autoCalculateAllElementsBounds()` 公共方法
- **2024-10-30**: 添加 TypeScript 类型定义文件 `test/src/index.d.ts`
- **2024-10-30**: 更新 `package.json` 添加 `types` 字段
- **2024-10-30**: 更新 `webpack.config.js` 自动复制类型文件
- **2024-10-30**: 创建本文件结构文档

---

**最后更新**: 2024-10-30


