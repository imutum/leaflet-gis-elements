/*! LeafletGISElements v1.0.0 | MIT License | https://github.com/yourusername/leaflet-gis-elements */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("LeafletGISElements",[],t):"object"==typeof exports?exports.LeafletGISElements=t():e.LeafletGISElements=t()}("undefined"!=typeof self?self:this,()=>(()=>{var e={12:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("north-arrow","compact",{name:"简洁指针",svg:(e=80)=>'\n            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 50 82">\n                \x3c!-- 半透明白色圆形背景 --\x3e\n                <circle cx="25" cy="41" r="22" fill="rgba(255, 255, 255, 0.9)" stroke="#333" stroke-width="2"/>\n                \n                \x3c!-- 北向指针（红色） --\x3e\n                <path d="M 25 20 L 20 42 L 25 40 L 30 42 Z" fill="#d32f2f" stroke="#b71c1c" stroke-width="1"/>\n                \n                \x3c!-- 南向指针（灰色） --\x3e\n                <path d="M 25 62 L 20 42 L 25 44 L 30 42 Z" fill="#757575" stroke="#424242" stroke-width="1"/>\n                \n                \x3c!-- 中心点 --\x3e\n                <circle cx="25" cy="41" r="3" fill="#333"/>\n                \n                \x3c!-- N标记 --\x3e\n                <text x="25" y="15" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#333" font-weight="bold">N</text>\n            </svg>\n        '})}()},17:()=>{L.GISElements=L.GISElements||{},L.GISElements.StyleRegistry=function(){const e={"north-arrow":{},"scale-bar":{},legend:{},graticule:{}};return{register(t,n,s){e[t]||(e[t]={}),e[t][n]=s,console.log(`✓ 已注册 ${t} 风格: ${n} (${s.name})`)},getStyles:t=>e[t]||{},getStyle:(t,n)=>e[t]?.[n]||null,hasStyle:(t,n)=>!!e[t]?.[n],list(t){if(t){const n=e[t]||{};return Object.keys(n).map(e=>({id:e,name:n[e].name}))}const n={};for(const t in e)n[t]=Object.keys(e[t]).map(n=>({id:n,name:e[t][n].name}));return n}}}()},45:()=>{L.GISElements=L.GISElements||{};L.GISElements.BoundsCalculator=class{constructor(e){this.map=e}calculateGraticuleBounds(e={}){const{padding:t=10}=e,n=document.querySelector(".lge-graticule-frame"),s=document.querySelectorAll(".lge-graticule-label");if(!n&&0===s.length)return null;const i=this.map.getContainer(),r=this._collectElementBounds(i,[{element:n},...Array.from(s).map(e=>({element:e,useInnerSpan:!0}))]);return this._addPadding(r,t,i)}calculateAllElementsBounds(e={}){const{padding:t=10,selectors:n=null}=e,s=this.map.getContainer(),i=(n||[".lge-graticule-frame",".lge-graticule-label",".leaflet-control-legend",".leaflet-control-scale-bar",".leaflet-control-north-arrow",".leaflet-control-map-info"]).flatMap(e=>Array.from(s.querySelectorAll(e))).filter(e=>null!==e.offsetParent).map(e=>({element:e,useInnerSpan:e.classList.contains("lge-graticule-label")}));if(0===i.length)return null;const r=this._collectElementBounds(s,i);return this._addPadding(r,t,s)}fromLatLngBounds(e){const t=this.map.latLngToContainerPoint(e.getNorthWest()),n=this.map.latLngToContainerPoint(e.getSouthEast());return{left:t.x,top:t.y,width:n.x-t.x,height:n.y-t.y}}getViewportBounds(){const e=this.map.getContainer();return{left:0,top:0,width:e.offsetWidth,height:e.offsetHeight}}_collectElementBounds(e,t){const n=e.getBoundingClientRect();let s=1/0,i=1/0,r=-1/0,o=-1/0;return t.forEach(({element:e,useInnerSpan:t})=>{if(!e)return;const a=(t&&e.querySelector("span")||e).getBoundingClientRect();s=Math.min(s,a.left-n.left),i=Math.min(i,a.top-n.top),r=Math.max(r,a.right-n.left),o=Math.max(o,a.bottom-n.top)}),{minX:s,minY:i,maxX:r,maxY:o}}_addPadding(e,t,n){const{minX:s,minY:i,maxX:r,maxY:o}=e;return{left:Math.max(0,s-t),top:Math.max(0,i-t),width:Math.min(n.offsetWidth,r+t)-Math.max(0,s-t),height:Math.min(n.offsetHeight,o+t)-Math.max(0,i-t)}}}},49:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("north-arrow","compass",{name:"罗盘样式",svg:(e=80)=>'\n            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100">\n                \x3c!-- 外圆 --\x3e\n                <circle cx="50" cy="50" r="48" fill="white" stroke="#333" stroke-width="2"/>\n                \n                \x3c!-- 刻度线 --\x3e\n                <line x1="50" y1="5" x2="50" y2="15" stroke="#333" stroke-width="2"/>\n                <line x1="50" y1="85" x2="50" y2="95" stroke="#333" stroke-width="1"/>\n                <line x1="95" y1="50" x2="85" y2="50" stroke="#333" stroke-width="1"/>\n                <line x1="5" y1="50" x2="15" y2="50" stroke="#333" stroke-width="1"/>\n                \n                \x3c!-- 北向箭头 --\x3e\n                <polygon points="50,15 42,50 50,45 58,50" fill="#d32f2f"/>\n                \n                \x3c!-- 南向箭头 --\x3e\n                <polygon points="50,85 42,50 50,55 58,50" fill="#666"/>\n                \n                \x3c!-- 中心圆 --\x3e\n                <circle cx="50" cy="50" r="6" fill="#333"/>\n                \n                \x3c!-- N标记 --\x3e\n                <text x="50" y="25" font-family="Georgia, serif" font-size="16" text-anchor="middle" fill="#333" font-weight="bold">N</text>\n            </svg>\n        '})}()},84:()=>{!function(){const e={name:"现代样式",renderContainer:t=>{if(!t||0===t.length)return'\n                    <div class="lge-legend-modern-container">\n                        <div class="lge-legend-modern-header">\n                            <span class="lge-legend-modern-title">图例</span>\n                        </div>\n                        <div class="lge-legend-modern-content">\n                            <div class="lge-legend-modern-empty">暂无图层</div>\n                        </div>\n                    </div>\n                ';return`\n                <div class="lge-legend-modern-container">\n                    <div class="lge-legend-modern-header">\n                        <span class="lge-legend-modern-title">图例</span>\n                    </div>\n                    <div class="lge-legend-modern-content">\n                        ${t.map(t=>`<div class="lge-legend-modern-item">${e.renderItem(t)}</div>`).join("")}\n                    </div>\n                </div>\n            `},renderItem:t=>{let n=`<div class="lge-legend-modern-layer-name">${t.name||"未命名图层"}</div>`;return"gradient"===t.type?n+=e.renderGradientLegend(t):n+=e.renderSimpleLegend(t),n},renderGradientLegend:e=>{const t=e.colors||["#0000ff","#00ffff","#00ff00","#ffff00","#ff0000"],n=e.labels||["低","","","","高"],s=e.unit||"";return`\n                <div class="lge-legend-modern-gradient">\n                    <div class="lge-legend-modern-colorbar" style="background: ${`linear-gradient(to right, ${t.join(", ")})`};"></div>\n                    <div class="lge-legend-modern-labels">\n                        ${n.map(e=>`<span class="lge-legend-modern-label">${e}</span>`).join("")}\n                    </div>\n                    ${s?`<div class="lge-legend-modern-unit">${s}</div>`:""}\n                </div>\n            `},renderSimpleLegend:e=>{const t=e.color||"#3388ff",n=e.type||"polygon",s=void 0!==e.fillOpacity?e.fillOpacity:.8;let i="";switch(n){case"point":i=`<div class="lge-legend-modern-symbol-point" style="background: ${t};"></div>`;break;case"line":i=`<div class="lge-legend-modern-symbol-line" style="background: ${t};"></div>`;break;default:i=`<div class="lge-legend-modern-symbol-polygon" style="background: ${t}; opacity: ${s};"></div>`}return`\n                <div class="lge-legend-modern-simple">\n                    ${i}\n                </div>\n            `}};L.GISElements.StyleRegistry.register("legend","modern",e)}()},85:()=>{L.GISElements=L.GISElements||{},L.GISElements.Storage={save(e,t){try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(t){return console.warn(`无法保存位置 [${e}]:`,t),!1}},load(e){try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return"x"in n&&"y"in n&&!("ratioX"in n)?(console.warn(`检测到旧版本的绝对坐标 [${e}]，已忽略`),this.remove(e),null):"number"!=typeof n.ratioX||"number"!=typeof n.ratioY?(console.warn(`无效的位置数据 [${e}]`),this.remove(e),null):n}catch(t){return console.warn(`无法加载位置 [${e}]:`,t),null}},remove(e){try{localStorage.removeItem(e)}catch(t){console.warn(`无法移除位置 [${e}]:`,t)}},clearAll(e){e.forEach(e=>this.remove(e))}}},94:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"topleft",draggable:!1!==e.draggable,storageKey:"mapInfoPosition",style:e.style||"professional"}),this.info={title:e.title||"",subtitle:e.subtitle||"",author:e.author||"",organization:e.organization||"",date:e.date||this._getCurrentDate(),dataSource:e.dataSource||"",projection:e.projection||"WGS84 / EPSG:4326",scale:e.scale||"1:100000",notes:e.notes||""},this.showConfig={title:!1!==e.showTitle,subtitle:!1!==e.showSubtitle,author:!1!==e.showAuthor,organization:!1!==e.showOrganization,date:!1!==e.showDate,dataSource:!1!==e.showDataSource,projection:!1!==e.showProjection,scale:!1!==e.showScale,notes:!1!==e.showNotes},this.maxWidth=e.maxWidth||400,this.minWidth=e.minWidth||200}getContainerClass(){return"leaflet-control-map-info"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("map-info")}getDefaultStyleName(){return"professional"}render(){if(!this.container)return;const e=this.getCurrentStyleObject();if(!e)return void console.warn(`地图注记样式 "${this.currentStyle}" 不存在`);const t={};Object.keys(this.info).forEach(e=>{this.showConfig[e]&&(t[e]=this.info[e])}),this.container.innerHTML=e.render(t),this.container.style.maxWidth=this.maxWidth+"px",this.container.style.minWidth=this.minWidth+"px"}setTitle(e){return this.info.title=e,this.render(),this}setSubtitle(e){return this.info.subtitle=e,this.render(),this}setAuthor(e){return this.info.author=e,this.render(),this}setOrganization(e){return this.info.organization=e,this.render(),this}setDate(e){return this.info.date=e,this.render(),this}setDataSource(e){return this.info.dataSource=e,this.render(),this}setProjection(e){return this.info.projection=e,this.render(),this}setScale(e){return this.info.scale=e,this.render(),this}setNotes(e){return this.info.notes=e,this.render(),this}setInfo(e){return Object.assign(this.info,e),this.render(),this}showField(e){return e in this.showConfig&&(this.showConfig[e]=!0,this.render()),this}hideField(e){return e in this.showConfig&&(this.showConfig[e]=!1,this.render()),this}setShowConfig(e){return Object.assign(this.showConfig,e),this.render(),this}setMaxWidth(e){return this.maxWidth=e,this.container&&(this.container.style.maxWidth=e+"px"),this}setMinWidth(e){return this.minWidth=e,this.container&&(this.container.style.minWidth=e+"px"),this}_getCurrentDate(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}getInfo(){return{...this.info}}getShowConfig(){return{...this.showConfig}}}L.Control.MapInfo=e,L.control.mapInfo=function(e){return new L.Control.MapInfo(e).createControl()}},142:()=>{L.GISElements=L.GISElements||{},L.GISElements.ExportConfig={DEFAULTS:{FORMAT:"png",QUALITY:1,SCALE:2,BACKGROUND_COLOR:"#ffffff",INCLUDE_BASEMAP:!0,FILENAME:"map_export"},BOUNDS:{DEFAULT_PADDING:10,MIN_WIDTH:100,MIN_HEIGHT:100,DEFAULT_PREVIEW:{left:100,top:100,width:600,height:400}},SELECTORS:{GIS_ELEMENTS:[".lge-graticule-frame",".lge-graticule-label",".leaflet-control-legend",".leaflet-control-scale-bar",".leaflet-control-north-arrow"],GRATICULE:{FRAME:".lge-graticule-frame",LABELS:".lge-graticule-label"},LEAFLET_PANES:{TILE:".leaflet-tile-pane",OVERLAY:".leaflet-overlay-pane",SHADOW:".leaflet-shadow-pane",MARKER:".leaflet-marker-pane",TOOLTIP:".leaflet-tooltip-pane",POPUP:".leaflet-popup-pane"}},PREVIEW:{BORDER_COLOR:"#ff6b6b",BORDER_WIDTH:2,BACKGROUND_ALPHA:.1,HINT_TEXT:"导出范围（可拖动调整）"},RENDER_WAIT_TIME:500,HTML2CANVAS:{useCORS:!0,allowTaint:!1,logging:!1,imageTimeout:0,removeContainer:!1},DEBUG:!1}},162:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.BaseControl{constructor(e={}){super(e),this.styles=e.styles||this.getDefaultStyles()||{},this.currentStyle=e.style||this.getDefaultStyleName()}onInit(e,t){super.onInit(e,t),this.onStyleInit(e,t),this.render()}setStyle(e){this.styles[e]?(this.currentStyle=e,this.map&&this.container&&this.onStyleInit(this.map,this.container),this.render()):console.warn(`样式 "${e}" 不存在`)}addStyle(e,t){this.styles[e]=t}removeStyle(e){if(this.styles[e]&&(delete this.styles[e],this.currentStyle===e)){const e=Object.keys(this.styles);e.length>0&&this.setStyle(e[0])}}getStylesList(){return Object.keys(this.styles).map(e=>({id:e,name:this.styles[e].name||e}))}getCurrentStyle(){return this.currentStyle}getCurrentStyleObject(){return this.styles[this.currentStyle]||null}hasStyle(e){return!!this.styles[e]}render(){throw new Error("子类必须实现 render() 方法")}getDefaultStyles(){return{}}getDefaultStyleName(){return"default"}onStyleInit(e,t){}}L.GISElements.StylableControl=e},183:()=>{L.GISElements=L.GISElements||{},L.GISElements.MapController=class{constructor(e,t={}){this.map=e,this.options=t,this.controls={northArrow:null,scaleBar:null,legend:null,graticule:null,mapInfo:null},this.leafletControls={northArrow:null,scaleBar:null,legend:null,graticule:null,mapInfo:null},this.visibility={northArrow:!0,scaleBar:!0,legend:!0,graticule:!0,mapInfo:!0},this._init()}_init(){this._createControls(),this._bindUIEvents()}_createControls(){const e=this.options.northArrow||{};this.controls.northArrow=new L.Control.NorthArrow({position:e.position||"topleft",style:e.style||"gis",size:e.size||80,draggable:!1!==e.draggable}),this.leafletControls.northArrow=this.controls.northArrow.createControl(),this.visibility.northArrow&&this.leafletControls.northArrow.addTo(this.map);const t=this.options.scaleBar||{};this.controls.scaleBar=new L.Control.ScaleBar({position:t.position||"bottomleft",style:t.style||"gis",maxWidth:t.maxWidth||150,draggable:!1!==t.draggable}),this.leafletControls.scaleBar=this.controls.scaleBar.createControl(),this.visibility.scaleBar&&this.leafletControls.scaleBar.addTo(this.map);const n=this.options.legend||{};this.controls.legend=new L.Control.Legend({position:n.position||"bottomright",style:n.style||"gis",layers:n.layers||[],draggable:!1!==n.draggable}),this.leafletControls.legend=this.controls.legend.createControl(),this.visibility.legend&&this.leafletControls.legend.addTo(this.map);const s=this.options.graticule||{};this.controls.graticule=new L.Control.Graticule({position:s.position||"topleft",style:s.style||"simple",interval:s.interval||null,lngInterval:s.lngInterval||null,latInterval:s.latInterval||null,showLabels:!1!==s.showLabels,enabled:!1!==s.enabled,frameEnabled:!1!==s.frameEnabled,frameDraggable:!1!==s.frameDraggable,frameResizable:!1!==s.frameResizable,draggable:!1!==s.draggable}),this.leafletControls.graticule=this.controls.graticule.createControl(),this.visibility.graticule&&this.leafletControls.graticule.addTo(this.map);const i=this.options.mapInfo||{};this.controls.mapInfo=new L.Control.MapInfo({position:i.position||"topleft",style:i.style||"professional",title:i.title||"",subtitle:i.subtitle||"",author:i.author||"",organization:i.organization||"",date:i.date||"",dataSource:i.dataSource||"",projection:i.projection||"WGS84 / EPSG:4326",scale:i.scale||"1:100000",notes:i.notes||"",draggable:!1!==i.draggable}),this.leafletControls.mapInfo=this.controls.mapInfo.createControl(),this.visibility.mapInfo&&this.leafletControls.mapInfo.addTo(this.map)}_bindUIEvents(){this._bindControlEvent("northArrow","showNorthArrow","northArrowStyle"),this._bindControlEvent("scaleBar","showScaleBar","scaleBarStyle"),this._bindControlEvent("legend","showLegend","legendStyle"),this._bindGraticuleEvents(),this._bindResetButton("resetNorthArrowPosition","northArrow"),this._bindResetButton("resetScaleBarPosition","scaleBar"),this._bindResetButton("resetLegendPosition","legend"),this._bindResetButton("resetGraticulePosition","graticule")}_bindControlEvent(e,t,n){const s=document.getElementById(t);s&&(s.addEventListener("change",t=>{t.target.checked?this.show(e):this.hide(e)}),s.checked=this.visibility[e]);const i=document.getElementById(n);i&&this.controls[e]&&(i.addEventListener("change",t=>{this.setStyle(e,t.target.value)}),i.value=this.controls[e].getCurrentStyle())}_bindGraticuleEvents(){const e=document.getElementById("showGraticule");e&&this.controls.graticule&&(e.addEventListener("change",e=>{e.target.checked?this.controls.graticule.enable():this.controls.graticule.disable()}),e.checked=this.controls.graticule.enabled);const t=document.getElementById("showGraticuleFrame");t&&this.controls.graticule&&(t.addEventListener("change",e=>{e.target.checked?this.controls.graticule.enableFrame():this.controls.graticule.disableFrame()}),t.checked=this.controls.graticule.frameEnabled)}_bindResetButton(e,t){const n=document.getElementById(e);n&&n.addEventListener("click",()=>{this.resetPosition(t)})}show(e){const t=this.leafletControls[e];t&&!this.visibility[e]&&(t.addTo(this.map),this.visibility[e]=!0)}hide(e){const t=this.leafletControls[e];t&&this.visibility[e]&&(this.map.removeControl(t),this.visibility[e]=!1)}toggle(e){this.visibility[e]?this.hide(e):this.show(e)}setStyle(e,t){if("graticule"===e)return;const n=this.controls[e];n&&"function"==typeof n.setStyle&&n.setStyle(t)}resetPosition(e){const t=this.controls[e];t&&"function"==typeof t.resetPosition&&(t.resetPosition(),L.GISElements.Notification&&L.GISElements.Notification.success(`${this._getControlDisplayName(e)}位置已重置`))}resetAllPositions(){Object.keys(this.controls).forEach(e=>{this.resetPosition(e)})}updateLegendLayers(e){this.controls.legend&&this.controls.legend.setLayers(e)}addLegendLayer(e){this.controls.legend&&this.controls.legend.addLayer(e)}removeLegendLayer(e){this.controls.legend&&this.controls.legend.removeLayer(e)}_getControlDisplayName(e){return{northArrow:"指北针",scaleBar:"比例尺",legend:"图例",graticule:"经纬度格网",mapInfo:"地图注记"}[e]||e}destroy(){Object.keys(this.leafletControls).forEach(e=>{const t=this.leafletControls[e];t&&this.map.removeControl(t)})}}},247:()=>{class e{constructor(e,t={}){this.element=e,this.options={threshold:t.threshold||5,onDragStart:t.onDragStart||null,onDragBegin:t.onDragBegin||null,onDragging:t.onDragging||null,onDragEnd:t.onDragEnd||null,constrainTo:t.constrainTo||null,updatePosition:void 0!==t.updatePosition&&t.updatePosition},this.isDragging=!1,this.startPos={x:0,y:0},this.startElementPos={left:0,top:0},this.hasMoved=!1,this._handlers=null,this._enabled=!1}enable(){if(this._enabled)return;const e=e=>{if(0===e.button){if(this.isDragging=!1,this.hasMoved=!1,this.startPos={x:e.clientX,y:e.clientY},this.options.updatePosition){const e=this.element.getBoundingClientRect(),t=this.element.offsetParent?this.element.offsetParent.getBoundingClientRect():{left:0,top:0};this.startElementPos={left:e.left-t.left,top:e.top-t.top}}this.options.onDragStart&&this.options.onDragStart(e),document.addEventListener("mousemove",t),document.addEventListener("mouseup",n),e.stopPropagation()}},t=e=>{const t={x:e.clientX-this.startPos.x,y:e.clientY-this.startPos.y};if(!this.isDragging&&(Math.abs(t.x)>this.options.threshold||Math.abs(t.y)>this.options.threshold)&&(this.isDragging=!0,this.options.onDragBegin&&this.options.onDragBegin()),this.isDragging){if(this.hasMoved=!0,this.options.updatePosition){let e=this.startElementPos.left+t.x,n=this.startElementPos.top+t.y;if(this.options.constrainTo){const t=this._constrainPosition(e,n);e=t.left,n=t.top}this.element.style.left=e+"px",this.element.style.top=n+"px"}this.options.onDragging&&this.options.onDragging(t,e),e.preventDefault()}},n=e=>{this.isDragging&&this.hasMoved&&(this.options.onDragEnd&&this.options.onDragEnd(e),e.preventDefault(),e.stopPropagation()),this.isDragging=!1,this.hasMoved=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n)};this.element.addEventListener("mousedown",e),this._handlers={onMouseDown:e,onMouseMove:t,onMouseUp:n},this._enabled=!0}disable(){this._enabled&&this._handlers&&(this.element.removeEventListener("mousedown",this._handlers.onMouseDown),this._handlers=null,this._enabled=!1)}_constrainPosition(e,t){const n=this.options.constrainTo.getBoundingClientRect(),s=this.element.getBoundingClientRect(),i=n.width-s.width,r=n.height-s.height;return{left:Math.max(0,Math.min(e,i)),top:Math.max(0,Math.min(t,r))}}destroy(){this.disable(),this.element=null,this.options=null}isEnabled(){return this._enabled}}L.GISElements=L.GISElements||{},L.GISElements.Draggable=e,L.GISElements.Resizable=class{constructor(e,t={}){this.element=e,this.options={handles:t.handles||["topleft","topright","bottomleft","bottomright"],minWidth:t.minWidth||100,minHeight:t.minHeight||100,handleColor:t.handleColor||"#333",handleSize:t.handleSize||12,onResizeStart:t.onResizeStart||null,onResizing:t.onResizing||null,onResizeEnd:t.onResizeEnd||null,getBounds:t.getBounds||null,setBounds:t.setBounds||null},this.handleConfigs={topleft:{x:0,y:0,cursor:"nwse-resize"},topright:{x:1,y:0,cursor:"nesw-resize"},bottomleft:{x:0,y:1,cursor:"nesw-resize"},bottomright:{x:1,y:1,cursor:"nwse-resize"},top:{x:.5,y:0,cursor:"ns-resize"},bottom:{x:.5,y:1,cursor:"ns-resize"},left:{x:0,y:.5,cursor:"ew-resize"},right:{x:1,y:.5,cursor:"ew-resize"}},this.handles=[],this._enabled=!1}enable(){this._enabled||(this.options.handles.forEach(e=>{const t=this.handleConfigs[e];if(!t)return void console.warn(`未知的控制点位置: ${e}`);const n=this._createHandle(e,t);this._makeHandleDraggable(n,e,t),this.handles.push({position:e,element:n,draggable:n._draggable})}),this._enabled=!0,this._updateHandlePositions())}disable(){this._enabled&&(this.handles.forEach(({element:e,draggable:t})=>{t&&t.destroy(),e.parentNode&&e.parentNode.removeChild(e)}),this.handles=[],this._enabled=!1)}updateHandlePositions(){this._updateHandlePositions()}_createHandle(e,t){const n=document.createElement("div");n.className=`resize-handle resize-handle-${e}`,n.style.cssText=`\n            position: absolute;\n            width: ${this.options.handleSize}px;\n            height: ${this.options.handleSize}px;\n            background: #fff;\n            border: 2px solid ${this.options.handleColor};\n            border-radius: 50%;\n            cursor: ${t.cursor};\n            z-index: 1001;\n            pointer-events: auto;\n        `;return(this.element.parentNode||document.body).appendChild(n),n}_makeHandleDraggable(t,n,s){let i=null;const r=new e(t,{threshold:0,onDragStart:e=>{i=this.options.getBounds?this.options.getBounds():this._getDefaultBounds(),t.style.transform="scale(1.3)",t.style.transition="transform 0.1s",this.options.onResizeStart&&this.options.onResizeStart(n),e.stopPropagation(),e.preventDefault()},onDragging:e=>{const t=this._calculateNewBounds(n,i,e);this.options.setBounds?this.options.setBounds(t):this._applyDefaultBounds(t),this._updateHandlePositions(),this.options.onResizing&&this.options.onResizing(t)},onDragEnd:()=>{t.style.transform="scale(1)",this.options.onResizeEnd&&this.options.onResizeEnd()}});r.enable(),t._draggable=r}_calculateNewBounds(e,t,n){const s={...t};switch(e){case"topleft":s.left=t.left+n.x,s.top=t.top+n.y,s.width=t.width-n.x,s.height=t.height-n.y;break;case"topright":s.top=t.top+n.y,s.width=t.width+n.x,s.height=t.height-n.y;break;case"bottomleft":s.left=t.left+n.x,s.width=t.width-n.x,s.height=t.height+n.y;break;case"bottomright":s.width=t.width+n.x,s.height=t.height+n.y;break;case"top":s.top=t.top+n.y,s.height=t.height-n.y;break;case"bottom":s.height=t.height+n.y;break;case"left":s.left=t.left+n.x,s.width=t.width-n.x;break;case"right":s.width=t.width+n.x}return s.width<this.options.minWidth&&(e.includes("left")&&(s.left=t.left+t.width-this.options.minWidth),s.width=this.options.minWidth),s.height<this.options.minHeight&&(e.includes("top")&&(s.top=t.top+t.height-this.options.minHeight),s.height=this.options.minHeight),s}_updateHandlePositions(){const e=this.options.getBounds?this.options.getBounds():this._getDefaultBounds();this.handles.forEach(({position:t,element:n})=>{const s=this.handleConfigs[t],i=e.left+s.x*e.width-this.options.handleSize/2,r=e.top+s.y*e.height-this.options.handleSize/2;n.style.left=i+"px",n.style.top=r+"px"})}_getDefaultBounds(){return{left:parseInt(this.element.style.left)||0,top:parseInt(this.element.style.top)||0,width:parseInt(this.element.style.width)||this.element.offsetWidth,height:parseInt(this.element.style.height)||this.element.offsetHeight}}_applyDefaultBounds(e){this.element.style.left=e.left+"px",this.element.style.top=e.top+"px",this.element.style.width=e.width+"px",this.element.style.height=e.height+"px"}destroy(){this.disable(),this.element=null,this.options=null}isEnabled(){return this._enabled}}},277:()=>{L.GISElements=L.GISElements||{};L.GISElements.MapExporter=class{constructor(e,t={}){this.map=e,this.config=L.GISElements.ExportConfig,this.format=t.format||this.config.DEFAULTS.FORMAT,this.quality=t.quality||this.config.DEFAULTS.QUALITY,this.filename=t.filename||this.config.DEFAULTS.FILENAME,this.scale=t.scale||this.config.DEFAULTS.SCALE,this.backgroundColor=t.backgroundColor||this.config.DEFAULTS.BACKGROUND_COLOR,this.includeBasemap=!1!==t.includeBasemap,this.exportBounds=null,this.layers=new Set,this.uiElements=new Set,this.isExporting=!1,this.loadingOverlay=null,this.svgFixer=new L.GISElements.SVGFixer(e),this.boundsCalculator=new L.GISElements.BoundsCalculator(e)}addLayer(e){return this.layers.add(e),this}removeLayer(e){return this.layers.delete(e),this}clearLayers(){return this.layers.clear(),this}addUIElement(e){return this.uiElements.add(e),this}removeUIElement(e){return this.uiElements.delete(e),this}clearUIElements(){return this.uiElements.clear(),this}setExportBounds(e){return this.exportBounds=e,this}setExportBoundsFromLatLng(e){return this.exportBounds=e?this.boundsCalculator.fromLatLngBounds(e):null,this}clearExportBounds(){return this.exportBounds=null,this}setFormat(e){return this.format=e,this}setQuality(e){return this.quality=Math.max(0,Math.min(1,e)),this}setFilename(e){return this.filename=e,this}setScale(e){return this.scale=Math.max(1,e),this}setIncludeBasemap(e){return this.includeBasemap=Boolean(e),this}configure(e){return e.format&&this.setFormat(e.format),void 0!==e.quality&&this.setQuality(e.quality),e.filename&&this.setFilename(e.filename),void 0!==e.scale&&this.setScale(e.scale),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),void 0!==e.includeBasemap&&this.setIncludeBasemap(e.includeBasemap),void 0!==e.exportBounds&&this.setExportBounds(e.exportBounds),this}getConfig(){return{format:this.format,quality:this.quality,filename:this.filename,scale:this.scale,backgroundColor:this.backgroundColor,includeBasemap:this.includeBasemap,exportBounds:this.exportBounds,layerCount:this.layers.size,uiElementCount:this.uiElements.size}}async export(){if(this.isExporting)throw new Error("导出正在进行中");if("undefined"==typeof html2canvas)throw new Error("html2canvas库未加载");this.isExporting=!0,this._showLoading();try{const e=this._prepareEnvironment();await this._waitForRender();const t=await this._captureMap(),n=this.exportBounds?this._cropCanvas(t,this.exportBounds):t;this._restoreEnvironment(e),this._downloadCanvas(n),this._log("info","导出成功")}catch(e){throw this._log("error","导出失败",e),e}finally{this.isExporting=!1,this._hideLoading()}}_prepareEnvironment(){const e={hiddenElements:[],removedLayers:[],tempLayers:[]};return this._hideUnwantedElements(e),this._manageLayers(e),e}_hideUnwantedElements(e){const t=this.map.getContainer().querySelectorAll("*");this.config.SELECTORS;t.forEach(t=>{(this.includeBasemap||!this._isTileElement(t))&&(this._isEssentialPane(t)||this._isWhitelisted(t))||this._hideElement(t,e)}),this._log("info",`隐藏了 ${e.hiddenElements.length} 个元素`)}_manageLayers(e){this.map.eachLayer(t=>{t instanceof L.TileLayer||t instanceof L.Renderer||this._isRenderer(t)||this.layers.has(t)||(this.map.removeLayer(t),e.removedLayers.push(t))}),this.layers.forEach(t=>{this.map.hasLayer(t)||(t.addTo(this.map),e.tempLayers.push(t))}),this._log("info",`移除 ${e.removedLayers.length} 个图层, 临时添加 ${e.tempLayers.length} 个图层`)}_restoreEnvironment(e){e.hiddenElements.forEach(({element:e,display:t})=>{e.style.display=t}),e.tempLayers.forEach(e=>{this.map.removeLayer(e)}),e.removedLayers.forEach(e=>{e.addTo(this.map)})}_isTileElement(e){return e.classList.contains("leaflet-tile-pane")||e.closest(".leaflet-tile-pane")}_isEssentialPane(e){return["leaflet-pane","leaflet-layer","leaflet-tile-container","leaflet-overlay-pane","leaflet-shadow-pane","leaflet-marker-pane","leaflet-tooltip-pane","leaflet-popup-pane"].some(t=>e.classList.contains(t)||e.closest(`.${t}`))}_isRenderer(e){return e._container&&("svg"===e._container.tagName||"CANVAS"===e._container.tagName)}_isWhitelisted(e){for(const t of this.uiElements)if("string"==typeof t)try{if(e.matches(t)||e.closest(t))return!0}catch(e){}else if(t instanceof HTMLElement&&(e===t||e.closest(e=>e===t)))return!0;return!1}_hideElement(e,t){"none"!==e.style.display&&(t.hiddenElements.push({element:e,display:e.style.display}),e.style.display="none")}_waitForRender(){return new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(e,this.config.RENDER_WAIT_TIME)})})})}async _captureMap(){const e=this.map.getContainer();return await html2canvas(e,{...this.config.HTML2CANVAS,backgroundColor:this.backgroundColor,scale:this.scale,onclone:e=>{this.svgFixer.fixAll(e)}})}_cropCanvas(e,t){const n=this.scale,s=Math.max(0,t.left*n),i=Math.max(0,t.top*n),r=Math.min(e.width-s,t.width*n),o=Math.min(e.height-i,t.height*n),a=document.createElement("canvas");a.width=r,a.height=o;return a.getContext("2d").drawImage(e,s,i,r,o,0,0,r,o),a}_downloadCanvas(e){const t="jpg"===this.format?"image/jpeg":"image/png",n=e.toDataURL(t,this.quality),s=document.createElement("a"),i=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);s.download=`${this.filename}_${i}.${this.format}`,s.href=n,s.click()}_showLoading(){const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        ",e.innerHTML='\n            <div style="\n                background: white;\n                padding: 30px;\n                border-radius: 8px;\n                text-align: center;\n                font-family: sans-serif;\n            ">\n                <div style="\n                    width: 40px;\n                    height: 40px;\n                    border: 4px solid #f3f3f3;\n                    border-top: 4px solid #3498db;\n                    border-radius: 50%;\n                    animation: spin 1s linear infinite;\n                    margin: 0 auto 15px;\n                "></div>\n                <p style="margin: 0; color: #333;">正在导出地图...</p>\n            </div>\n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            </style>\n        ',this.loadingOverlay=e,document.body.appendChild(e)}_hideLoading(){this.loadingOverlay&&(this.loadingOverlay.remove(),this.loadingOverlay=null)}_log(e,t,n=null){if(!this.config.DEBUG&&"info"===e)return;console[{info:"log",warn:"warn",error:"error"}[e]||"log"]("[MapExporter]",t,n||"")}}},278:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("graticule","simple",{name:"简单样式",meridian:{color:"#666",weight:1,opacity:.5,dashArray:null},parallel:{color:"#666",weight:1,opacity:.5,dashArray:null},frame:{color:"#333",weight:2,opacity:.8},label:{fontSize:11,fontFamily:"Arial, sans-serif",color:"#333"}})}()},283:()=>{const e={17:.001,15:.005,13:.01,11:.05,9:.1,7:.5,5:1,3:5,DEFAULT:10};L.GISElements=L.GISElements||{},L.GISElements.Constants={DRAG_THRESHOLD:5,DRAG_OPACITY:.6,DRAG_CURSOR:"grabbing",MIN_FRAME_WIDTH:100,MIN_FRAME_HEIGHT:100,RESIZE_HANDLE_SIZE:12,RESIZE_HANDLE_SCALE:1.3,RESIZE_HANDLE_BORDER_WIDTH:2,EXPORT_BOUNDS_PADDING:10,AUTO_BOUNDS_PADDING:20,CONTROL_SPACING:10,Z_INDEX:{MAP_BASE:0,GRATICULE_LINES:100,GRATICULE_LABELS:200,GRATICULE_FRAME:400,EXPORT_PREVIEW:500,EXPORT_PREVIEW_HANDLES:501,CONTROL_CONTAINER:1e3,RESIZE_HANDLES:1001,NOTIFICATION:1e4},TRANSITION_DURATION:300,NOTIFICATION_DURATION:2e3,MAP_RENDER_WAIT:200,COLORS:{FRAME_BORDER:"#333",PREVIEW_BORDER:"#ff6b6b",HANDLE_BG:"#fff",HANDLE_BORDER:"#333",SUCCESS:"#4CAF50",WARNING:"#ff9800",ERROR:"#f44336"},GRATICULE_DEFAULTS:{FRAME_LEFT:100,FRAME_TOP:100,FRAME_WIDTH:400,FRAME_HEIGHT:300,FRAME_WEIGHT:2,FRAME_OPACITY:.8,LINE_COLOR:"#666",LINE_WEIGHT:1,LINE_OPACITY:.5,LABEL_FONT_SIZE:11,LABEL_FONT_FAMILY:"Arial, sans-serif"},GRATICULE_INTERVALS:e,EXPORT_DEFAULTS:{FORMAT:"png",QUALITY:1,SCALE:2,FILENAME:"thematic_map",AREA:"auto"},EXPORT_EXCLUDE_SELECTORS:[".leaflet-control-zoom",".control-panel",".toggle-panel",".leaflet-control-attribution",".leaflet-control-export"],EXPORT_INCLUDE_SELECTORS:[".leaflet-control-legend",".leaflet-control-scale-bar",".leaflet-control-north-arrow",".leaflet-control-graticule",".lge-graticule-frame",".lge-graticule-label"],CONTROL_POSITIONS:{NORTH_ARROW:"topleft",SCALE_BAR:"bottomleft",LEGEND:"bottomright",EXPORT:"topright",GRATICULE:"topleft"},CONTROL_DEFAULT_STYLES:{NORTH_ARROW:"gis",SCALE_BAR:"gis",LEGEND:"gis"},CONTROL_SIZES:{NORTH_ARROW:80,SCALE_BAR_MAX_WIDTH:150,LEGEND_MAX_WIDTH:300,LEGEND_MAX_HEIGHT:400},STORAGE_KEYS:{NORTH_ARROW_POSITION:"northArrowPosition",SCALE_BAR_POSITION:"scaleBarPosition",LEGEND_POSITION:"legendPosition",GRATICULE_FRAME:"graticuleFrame"},EVENTS:{CONTROL_POSITION_CHANGED:"controlPositionChanged",CONTROL_STYLE_CHANGED:"controlStyleChanged",GRATICULE_UPDATED:"graticuleUpdated",EXPORT_STARTED:"exportStarted",EXPORT_COMPLETED:"exportCompleted",EXPORT_FAILED:"exportFailed"},getGraticuleInterval:function(t){for(const[n,s]of Object.entries(e))if("DEFAULT"!==n&&t>=parseInt(n))return s;return e.DEFAULT}}},285:()=>{L.GISElements.StyleRegistry.register("scale-bar","gis",{name:"GIS专业",render:e=>{const{width:t,label:n,meters:s}=e,i=s/2,r=s;let o,a;if(r>=1e3){const e=i/1e3;o=e;const t=r/1e3;a=(t%1==0?t:t.toFixed(1))+" km"}else o=i,a=(r%1==0?r:r.toFixed(1))+" m";return`\n                <div class="lge-scale-bar-gis" style="width: ${t}px;">\n                    <div class="lge-scale-bar-ruler">\n                        \x3c!-- 上排：黑-白-黑-白 --\x3e\n                        <div class="lge-scale-segment lge-scale-segment-black" style="top: 0; left: 0; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-white" style="top: 0; left: 25%; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-black" style="top: 0; left: 50%; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-white" style="top: 0; left: 75%; width: 25%;"></div>\n                        \x3c!-- 下排：白-黑-白-黑 --\x3e\n                        <div class="lge-scale-segment lge-scale-segment-white" style="top: 50%; left: 0; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-black" style="top: 50%; left: 25%; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-white" style="top: 50%; left: 50%; width: 25%;"></div>\n                        <div class="lge-scale-segment lge-scale-segment-black" style="top: 50%; left: 75%; width: 25%;"></div>\n                    </div>\n                    <div class="lge-scale-bar-labels">\n                        <div class="lge-scale-label lge-scale-label-start">0</div>\n                        <div class="lge-scale-label lge-scale-label-middle">${o}</div>\n                        <div class="lge-scale-label lge-scale-label-end">${a}</div>\n                    </div>\n                </div>\n            `}})},294:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"bottomleft",draggable:!1!==e.draggable,storageKey:"scaleBarPosition",dragThreshold:5,styles:e.styles,style:e.style||"gis"}),this.maxWidth=e.maxWidth||300,this.metric=!1!==e.metric,this.imperial=e.imperial||!1,this.updateWhenIdle=e.updateWhenIdle||!1,this.scaleData={meters:0,width:0,label:""},this._updateHandler=null}getContainerClass(){return"leaflet-control-scale-bar"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("scale-bar")}getDefaultStyleName(){return"gis"}onStyleInit(e,t){const n=this.updateWhenIdle?"moveend":"move";this._updateHandler=()=>this.update(),e.on(n,this._updateHandler),e.on("zoom",this._updateHandler),this.update()}onDestroy(){if(this._updateHandler&&this.map){const e=this.updateWhenIdle?"moveend":"move";this.map.off(e,this._updateHandler),this.map.off("zoom",this._updateHandler)}}update(){if(!this.map||!this.container)return;const e=this.map.getBounds(),t=e.getCenter().lat,n=6378137*Math.PI*Math.cos(t*Math.PI/180)*(e.getNorthEast().lng-e.getSouthWest().lng)/180,s=this.map.getSize();let i=0;s.x>0&&(i=n*(this.maxWidth/s.x)),this.scaleData=this._getRoundNum(i),this.render()}render(){if(!this.container)return;const e=this.getCurrentStyleObject();if(!e)return void console.warn(`比例尺样式 "${this.currentStyle}" 不存在`);const t=e.render(this.scaleData);this.container.innerHTML="";const n=document.createElement("div");n.className="scale-bar-content",n.innerHTML=t,this.container.appendChild(n)}setMaxWidth(e){this.maxWidth=e,this.update()}getMaxWidth(){return this.maxWidth}setMetric(e){this.metric=e,this.update()}setImperial(e){this.imperial=e,this.update()}setUpdateWhenIdle(e){if(this.updateWhenIdle!==e&&(this.updateWhenIdle=e,this._updateHandler&&this.map)){const t=e?"move":"moveend";this.map.off(t,this._updateHandler);const n=e?"moveend":"move";this.map.on(n,this._updateHandler)}}getOptions(){return{maxWidth:this.maxWidth,metric:this.metric,imperial:this.imperial,updateWhenIdle:this.updateWhenIdle}}_getRoundNum(e){const t=Math.pow(10,(Math.floor(e)+"").length-1);let n=e/t;n>=10?n=10:n>=5?n=5:n>=3?n=3:(n=Math.round(2*n)/2,n<1&&(n=1));const s=t*n,i=s/e,r=Math.round(this.maxWidth*i);let o;if(s>=1e3){const e=s/1e3;o=(e%1==0?e:e.toFixed(1))+" km"}else o=(s%1==0?s:s.toFixed(1))+" m";return{meters:s,width:r,label:o}}}L.Control.ScaleBar=e,L.control.scaleBar=function(e){return new L.Control.ScaleBar(e).createControl()}},359:()=>{L.GISElements.StyleRegistry.register("scale-bar","minimal",{name:"简约线条",render:e=>{const{width:t,label:n}=e;return`\n                <div class="lge-scale-bar-minimal" style="width: ${t}px;">\n                    <div class="lge-scale-bar-top-line"></div>\n                    <div class="lge-scale-bar-label">${n}</div>\n                </div>\n            `}})},370:()=>{L.GISElements=L.GISElements||{},L.GISElements.StyleRegistry=L.GISElements.StyleRegistry||{},L.GISElements.StyleRegistry.register("map-info","compact",{id:"compact",name:"紧凑版",description:"简洁风格，适合空间有限的地图",render(e){const t=[];e.title&&t.push(`\n                <div class="lge-map-info-title-compact">\n                    ${this._escapeHtml(e.title)}\n                </div>\n            `),e.subtitle&&t.push(`\n                <div class="lge-map-info-subtitle-compact">\n                    ${this._escapeHtml(e.subtitle)}\n                </div>\n            `);const n=[];e.author&&n.push(this._escapeHtml(e.author)),e.organization&&n.push(this._escapeHtml(e.organization)),e.date&&n.push(this._escapeHtml(e.date)),n.length>0&&t.push(`\n                <div class="lge-map-info-metadata-compact">\n                    ${n.join(" · ")}\n                </div>\n            `);const s=[];return e.dataSource&&s.push(`来源: ${this._escapeHtml(e.dataSource)}`),e.projection&&s.push(this._escapeHtml(e.projection)),e.scale&&s.push(this._escapeHtml(e.scale)),s.length>0&&t.push(`\n                <div class="lge-map-info-extra-compact">\n                    ${s.join(" | ")}\n                </div>\n            `),e.notes&&t.push(`\n                <div class="lge-map-info-notes-compact">\n                    ${this._escapeHtml(e.notes)}\n                </div>\n            `),t.join("")},_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}})},391:()=>{L.GISElements.StyleRegistry.register("scale-bar","double",{name:"双行对比",render:e=>{const{width:t,label:n,meters:s}=e,i=(621371e-9*s).toFixed(2);return`\n                <div class="lge-scale-bar-double" style="width: ${t}px;">\n                    <div class="lge-scale-row">\n                        <div class="lge-scale-bar-label">${n}</div>\n                        <div class="lge-scale-bar-line">\n                            <div class="lge-scale-segment" style="width: 50%; background: #000;"></div>\n                            <div class="lge-scale-segment" style="width: 50%; background: #fff; border: 1px solid #000; border-left: none;"></div>\n                        </div>\n                    </div>\n                    <div class="lge-scale-row">\n                        <div class="lge-scale-bar-label">${i>=1?i+" mi":(5280*i).toFixed(0)+" ft"}</div>\n                        <div class="lge-scale-bar-line">\n                            <div class="lge-scale-segment" style="width: 50%; background: #555;"></div>\n                            <div class="lge-scale-segment" style="width: 50%; background: #ddd; border: 1px solid #555; border-left: none;"></div>\n                        </div>\n                    </div>\n                </div>\n            `}})},420:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("export-preview","default",{name:"默认样式",render:()=>'\n                <div class="lge-export-preview-buttons">\n                    <button class="lge-export-preview-btn" title="显示/隐藏预览边框">\n                        <svg width="20" height="20" viewBox="0 0 20 20">\n                            <rect x="2" y="2" width="16" height="16" \n                                  fill="none" stroke="currentColor" \n                                  stroke-width="2" stroke-dasharray="2,2"/>\n                            <circle cx="10" cy="10" r="3" fill="currentColor"/>\n                        </svg>\n                        <span>预览</span>\n                    </button>\n                    <button class="lge-export-btn" title="导出地图">\n                        <svg width="20" height="20" viewBox="0 0 20 20">\n                            <path d="M10 2 L10 12 M10 12 L7 9 M10 12 L13 9" \n                                  fill="none" stroke="currentColor" stroke-width="2"/>\n                            <path d="M4 14 L4 18 L16 18 L16 14" \n                                  fill="none" stroke="currentColor" stroke-width="2"/>\n                        </svg>\n                        <span>导出</span>\n                    </button>\n                </div>\n            '})}()},469:()=>{L.GISElements=L.GISElements||{},L.GISElements.Notification={success(e,t=2e3){this._show(e,"success",t)},error(e,t=3e3){this._show(e,"error",t)},warning(e,t=2500){this._show(e,"warning",t)},info(e,t=2e3){this._show(e,"info",t)},_show(e,t,n){const s=document.createElement("div");s.className=`lge-notification lge-notification-${t}`,s.textContent=e,Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"4px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:L.GISElements.Constants?.Z_INDEX?.NOTIFICATION||"10000",fontSize:"14px",color:"#fff",backgroundColor:this._getColor(t),transition:"opacity 0.3s, transform 0.3s",transform:"translateX(0)",opacity:"1"}),document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transform="translateX(20px)",setTimeout(()=>{s.parentNode&&document.body.removeChild(s)},300)},n)},_getColor(e){const t={success:"#4CAF50",error:"#f44336",warning:"#ff9800",info:"#2196F3"};return t[e]||t.info}}},470:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"topleft",draggable:!1!==e.draggable,storageKey:"northArrowPosition",dragThreshold:5,styles:e.styles,style:e.style||"gis"}),this.size=e.size||80}getContainerClass(){return"leaflet-control-north-arrow"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("north-arrow")}getDefaultStyleName(){return"gis"}onStyleInit(e,t){t.style.width=this.size+"px",t.style.height=this.size+"px",t.style.background="transparent"}render(){if(!this.container)return;const e=this.getCurrentStyleObject();if(!e)return void console.warn(`指北针样式 "${this.currentStyle}" 不存在`);const t="function"==typeof e.svg?e.svg(this.size):e.svg;this.container.innerHTML="",this.container.style.width=this.size+"px",this.container.style.height=this.size+"px",this.container.style.background="transparent";const n=document.createElement("div");n.className="lge-north-arrow-content",n.title=e.name,n.innerHTML=t,this.container.appendChild(n)}setSize(e){this.size=e,this.container&&(this.container.style.width=e+"px",this.container.style.height=e+"px",this.render())}getSize(){return this.size}getOptions(){return{size:this.size}}}L.Control.NorthArrow=e,L.control.northArrow=function(e){return new L.Control.NorthArrow(e).createControl()}},532:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("north-arrow","leaflet",{name:"Leaflet经典",svg:(e=80)=>'\n            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 50 82">\n                \x3c!-- 白色圆形背景 --\x3e\n                <circle cx="25" cy="41" r="24" fill="white" stroke="black" stroke-width="1"/>\n                \n                \x3c!-- 字母 N --\x3e\n                <text x="25" y="20" font-family="Arial, sans-serif" font-size="16" text-anchor="middle" fill="black" font-weight="bold">N</text>\n                \n                \x3c!-- 红色北向箭头 --\x3e\n                <polygon points="25,25 20,50 25,47 30,50" fill="red"/>\n                \n                \x3c!-- 白色南向箭头 --\x3e\n                <polygon points="25,55 20,50 25,52 30,50" fill="white" stroke="black" stroke-width="0.5"/>\n            </svg>\n        '})}()},558:()=>{!function(){const e={name:"GIS专业",renderContainer:t=>{if(!t||0===t.length)return'\n                    <div class="lge-legend-gis-container">\n                        <div class="lge-legend-gis-title">图例</div>\n                        <div class="lge-legend-gis-no-layer">无图层</div>\n                    </div>\n                ';return`\n                <div class="lge-legend-gis-container">\n                    <div class="lge-legend-gis-title">图例</div>\n                    ${t.map((t,n)=>`<div class="lge-legend-gis-item" ${n>0?'style="margin-top: 8px;"':""}>${e.renderItem(t)}</div>`).join("")}\n                </div>\n            `},renderItem:t=>{let n=`<div class="lge-legend-gis-layer-name">${t.name||"未命名图层"}</div>`;return"gradient"===t.type?n+=e.renderGradientLegend(t):n+=e.renderSimpleLegend(t),n},renderGradientLegend:e=>{const t=e.colors||["#0000ff","#00ffff","#00ff00","#ffff00","#ff0000"],n=e.labels||["低","","","","高"],s=e.unit||"";return`\n                <div class="lge-legend-gis-gradient">\n                    <div class="lge-legend-gis-colorbar" style="background: ${`linear-gradient(to right, ${t.join(", ")})`};"></div>\n                    <div class="lge-legend-gis-labels">\n                        ${n.map(e=>`<div class="lge-legend-gis-label">${e}</div>`).join("")}\n                    </div>\n                    ${s?`<div class="lge-legend-gis-unit">${s}</div>`:""}\n                </div>\n            `},renderSimpleLegend:t=>{const n=t.color||"#3388ff",s=void 0!==t.fillOpacity?t.fillOpacity:.5;let i="";switch(t.type||"polygon"){case"point":i=`<div class="lge-legend-gis-symbol-point" style="background: ${n};"></div>`;break;case"line":i=`<div class="lge-legend-gis-symbol-line" style="background: ${n};"></div>`;break;default:i=`<div class="lge-legend-gis-symbol-polygon" style="background: ${e.hexToRgba(n,s)}; border: 2px solid ${n};"></div>`}return`\n                <div class="lge-legend-gis-simple">\n                    ${i}\n                </div>\n            `},hexToRgba:(e,t)=>{e=e.replace("#","");return`rgba(${parseInt(e.substring(0,2),16)}, ${parseInt(e.substring(2,4),16)}, ${parseInt(e.substring(4,6),16)}, ${t})`}};L.GISElements.StyleRegistry.register("legend","gis",e)}()},564:()=>{L.GISElements=L.GISElements||{},L.GISElements.Coordinate={absoluteToRelative(e,t,n){if(!n)return{ratioX:0,ratioY:0};const s=n.getBoundingClientRect(),i=e/s.width,r=t/s.height;return{ratioX:Math.max(0,Math.min(1,i)),ratioY:Math.max(0,Math.min(1,r))}},relativeToAbsolute(e,t,n,s){if(!n||!s)return{x:0,y:0};const i=n.getBoundingClientRect(),r=s.getBoundingClientRect(),o=e*i.width,a=t*i.height;return{x:Math.max(0,Math.min(o,i.width-r.width)),y:Math.max(0,Math.min(a,i.height-r.height))}},constrainPosition(e,t,n,s){if(!n||!s)return{x:e,y:t};const i=n.getBoundingClientRect(),r=s.getBoundingClientRect(),o=i.width-r.width,a=i.height-r.height;return{x:Math.max(0,Math.min(e,o)),y:Math.max(0,Math.min(t,a))}}}},566:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"topright",draggable:!1,storageKey:"exportPreviewPosition",style:e.style||"default"}),this.config=L.GISElements.ExportConfig,this.exportOptions={format:e.format||this.config.DEFAULTS.FORMAT,quality:e.quality||this.config.DEFAULTS.QUALITY,filename:e.filename||this.config.DEFAULTS.FILENAME,scale:e.scale||this.config.DEFAULTS.SCALE},this.exportBounds=e.exportBounds||null,this.autoCalculateBounds=!1!==e.autoCalculateBounds,this.boundsMode=e.boundsMode||"graticule",this.layers=new Set,this.uiElements=new Set,this.previewVisible=!1,this.previewBorder=null,this.borderDraggable=null,this.borderResizable=null,this.exporter=null,this.boundsCalculator=null}getContainerClass(){return"leaflet-control-export-preview"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("export-preview")}getDefaultStyleName(){return"default"}onStyleInit(e,t){this.exporter=new L.GISElements.MapExporter(e,this.exportOptions),this.boundsCalculator=new L.GISElements.BoundsCalculator(e)}render(){if(!this.container)return;const e=this.getCurrentStyleObject();e?(this.container.innerHTML=e.render(),this._bindEvents()):console.warn(`导出预览样式 "${this.currentStyle}" 不存在`)}_bindEvents(){const e=this.container.querySelector(".lge-export-preview-btn"),t=this.container.querySelector(".lge-export-btn");e&&e.addEventListener("click",()=>this.togglePreview()),t&&t.addEventListener("click",()=>this.export())}showPreview(){this.previewVisible||(this.autoCalculateBounds&&!this.exportBounds&&(this.exportBounds=this._calculateBounds()),this.exportBounds||(this.exportBounds=this.config.BOUNDS.DEFAULT_PREVIEW),this._createPreviewBorder(),this.previewVisible=!0)}hidePreview(){this.previewVisible&&(this._destroyPreviewBorder(),this.previewVisible=!1)}togglePreview(){this.previewVisible?this.hidePreview():this.showPreview()}_calculateBounds(){switch(this.boundsMode){case"graticule":return this.boundsCalculator.calculateGraticuleBounds();case"all":return this.boundsCalculator.calculateAllElementsBounds();case"viewport":return this.boundsCalculator.getViewportBounds();default:return null}}_createPreviewBorder(){const e=this.config,t=L.GISElements.Constants?.Z_INDEX.EXPORT_PREVIEW||500;this.previewBorder=document.createElement("div"),this.previewBorder.className="lge-export-preview-border",this.previewBorder.style.cssText=`\n            position: absolute;\n            left: ${this.exportBounds.left}px;\n            top: ${this.exportBounds.top}px;\n            width: ${this.exportBounds.width}px;\n            height: ${this.exportBounds.height}px;\n            border: ${e.PREVIEW.BORDER_WIDTH}px dashed ${e.PREVIEW.BORDER_COLOR};\n            background-color: ${this._hexToRgba(e.PREVIEW.BORDER_COLOR,e.PREVIEW.BACKGROUND_ALPHA)};\n            box-sizing: border-box;\n            pointer-events: auto;\n            z-index: ${t};\n            cursor: move;\n        `;const n=document.createElement("div");n.textContent=e.PREVIEW.HINT_TEXT,n.style.cssText=`\n            position: absolute;\n            top: -25px;\n            left: 0;\n            background: ${e.PREVIEW.BORDER_COLOR};\n            color: #fff;\n            padding: 2px 8px;\n            font-size: 12px;\n            border-radius: 3px;\n            white-space: nowrap;\n        `,this.previewBorder.appendChild(n),this.map.getContainer().appendChild(this.previewBorder),this._enableDragging(),this._enableResizing()}_destroyPreviewBorder(){this.borderDraggable&&(this.borderDraggable.destroy(),this.borderDraggable=null),this.borderResizable&&(this.borderResizable.destroy(),this.borderResizable=null),this.previewBorder&&(this.previewBorder.remove(),this.previewBorder=null)}_enableDragging(){if(!L.GISElements.Draggable)return;let e=null;this.borderDraggable=new L.GISElements.Draggable(this.previewBorder,{threshold:5,onDragStart:()=>{e={...this.exportBounds},this.previewBorder.style.opacity="0.7",this.map.dragging&&this.map.dragging.disable()},onDragging:t=>{this.exportBounds.left=e.left+t.x,this.exportBounds.top=e.top+t.y,this.previewBorder.style.left=this.exportBounds.left+"px",this.previewBorder.style.top=this.exportBounds.top+"px",this.borderResizable&&this.borderResizable.updateHandlePositions(),this.exporter?.setExportBounds(this.exportBounds)},onDragEnd:()=>{this.previewBorder.style.opacity="1",this.map.dragging&&this.map.dragging.enable(),this.exporter?.setExportBounds(this.exportBounds)}}),this.borderDraggable.enable()}_enableResizing(){L.GISElements.Resizable&&(this.borderResizable=new L.GISElements.Resizable(this.previewBorder,{minWidth:this.config.BOUNDS.MIN_WIDTH,minHeight:this.config.BOUNDS.MIN_HEIGHT,handleColor:this.config.PREVIEW.BORDER_COLOR,onResizing:e=>{this.exportBounds=e,this.exporter?.setExportBounds(e)},getBounds:()=>this.exportBounds,setBounds:e=>{this.exportBounds=e,this._updateBorderStyle(e),this.exporter?.setExportBounds(e)}}),this.borderResizable.enable())}_syncBounds(){this.exportBounds={left:parseInt(this.previewBorder.style.left)||0,top:parseInt(this.previewBorder.style.top)||0,width:parseInt(this.previewBorder.style.width)||100,height:parseInt(this.previewBorder.style.height)||100},this.exporter?.setExportBounds(this.exportBounds),this.borderResizable&&this.borderResizable.updateHandlePositions()}_updateBorderStyle(e){this.previewBorder&&(this.previewBorder.style.left=e.left+"px",this.previewBorder.style.top=e.top+"px",this.previewBorder.style.width=e.width+"px",this.previewBorder.style.height=e.height+"px",this.borderResizable&&this.borderResizable.updateHandlePositions())}async export(){if(!this.exporter)throw new Error("导出器未初始化");try{this.exporter.setExportBounds(this.exportBounds),this.exporter.clearLayers(),this.exporter.clearUIElements(),this.layers.forEach(e=>this.exporter.addLayer(e)),this.uiElements.forEach(e=>this.exporter.addUIElement(e)),await this.exporter.export(),L.GISElements.Notification?.success("地图导出成功")}catch(e){throw console.error("[导出] 失败:",e),L.GISElements.Notification?.error("导出失败: "+e.message),e}}addLayer(e){return this.layers.add(e),this}addUIElement(e){return this.uiElements.add(e),this}removeLayer(e){return this.layers.delete(e),this}removeUIElement(e){return this.uiElements.delete(e),this}clearWhitelist(){return this.layers.clear(),this.uiElements.clear(),this}setExportBounds(e){return this.exportBounds=e,this.previewBorder&&this._updateBorderStyle(e),this.exporter?.setExportBounds(e),this}setBoundsMode(e){return this.boundsMode=e,this}recalculateBounds(){return this.exportBounds=this._calculateBounds(),this.previewBorder&&this.exportBounds&&this._updateBorderStyle(this.exportBounds),this}autoCalculateExportBounds(){return this.boundsCalculator?this.boundsCalculator.calculateGraticuleBounds():(console.warn("BoundsCalculator 未初始化"),null)}autoCalculateAllElementsBounds(){return this.boundsCalculator?this.boundsCalculator.calculateAllElementsBounds():(console.warn("BoundsCalculator 未初始化"),null)}setFormat(e){return this.exportOptions.format=e,this.exporter?.setFormat(e),this}setQuality(e){return this.exportOptions.quality=e,this.exporter?.setQuality(e),this}setFilename(e){return this.exportOptions.filename=e,this.exporter?.setFilename(e),this}setScale(e){return this.exportOptions.scale=e,this.exporter?.setScale(e),this}_hexToRgba(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}onDestroy(){this.hidePreview(),this.clearWhitelist(),this.exporter=null,this.boundsCalculator=null}}L.Control.ExportPreview=e,L.control.exportPreview=function(e){return new L.Control.ExportPreview(e).createControl()}},600:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("north-arrow","gis",{name:"GIS专业",svg:(e=80)=>'\n            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 50 82">\n                \x3c!-- 背景透明 --\x3e\n                <rect width="100%" height="100%" fill="none"/>\n                \n                \x3c!-- 字母 N --\x3e\n                <text x="25" y="25" font-family="Times New Roman, serif" font-size="20" text-anchor="middle" fill="black">N</text>\n                \n                \x3c!-- 黑色三角箭头 --\x3e\n                <polygon points="25,25 12,70 25,55 38,70" fill="black"/>\n            </svg>\n        '})}()},750:()=>{L.GISElements=L.GISElements||{};L.GISElements.SVGFixer=class{constructor(e){this.map=e,this.config=L.GISElements.ExportConfig}fixAll(e){this.fixGraticuleLabels(e),this.fixSVGElements(e)}fixGraticuleLabels(e){const t=document.querySelectorAll(this.config.SELECTORS.GRATICULE.LABELS),n=e.querySelectorAll(this.config.SELECTORS.GRATICULE.LABELS);if(0===t.length)return;const s=this.map.getContainer().getBoundingClientRect();t.forEach((e,t)=>{if(t>=n.length)return;const i=n[t],r=e.querySelector("span"),o=i.querySelector("span");if(!r||!o)return;const a=r.getBoundingClientRect(),l=a.left-s.left,h=a.top-s.top;i.style.cssText=`\n                position: absolute !important;\n                left: ${l}px !important;\n                top: ${h}px !important;\n                transform: none !important;\n            `,o.style.cssText="\n                transform: none !important;\n                position: static !important;\n                margin: 0 !important;\n            "})}fixSVGElements(e){const t=this.map.getContainer().querySelector(this.config.SELECTORS.LEAFLET_PANES.OVERLAY),n=e.querySelector(this.config.SELECTORS.LEAFLET_PANES.OVERLAY);if(!t||!n)return;const s=t.querySelector("svg"),i=n.querySelector("svg");s&&i&&this._convertSVGToCanvas(e,s,n,i)}_convertSVGToCanvas(e,t,n,s){const i=this.map.getContainer().getBoundingClientRect(),r=t.getBoundingClientRect(),o=r.left-i.left,a=r.top-i.top,l=Math.round(r.width),h=Math.round(r.height);if(l<=0||h<=0)return this._log("warn","SVG尺寸无效"),!1;const d=e.createElement("canvas");d.width=l,d.height=h,d.style.cssText=`\n            position: absolute;\n            left: ${o}px;\n            top: ${a}px;\n            pointer-events: none;\n        `;const c=d.getContext("2d");return this._drawSVGToCanvas(t,d,c)?(n.innerHTML="",n.appendChild(d),this._log("info","SVG转Canvas成功"),!0):(this._log("warn","SVG转Canvas失败"),!1)}_drawSVGToCanvas(e,t,n){const s=e.querySelectorAll("path");if(0===s.length)return!1;const i=this._getSVGTransform(e,t);n.save(),n.clearRect(0,0,t.width,t.height),i&&(n.translate(i.offsetX,i.offsetY),n.scale(i.scaleX,i.scaleY));let r=0;return s.forEach(e=>{this._drawPath(n,e)&&r++}),n.restore(),this._log("info",`绘制了 ${r}/${s.length} 条路径`),r>0}_getSVGTransform(e,t){const n=e.getAttribute("viewBox");if(!n)return null;const[s,i,r,o]=n.split(/\s+/).map(Number),a=parseFloat(e.getAttribute("width"))||t.width,l=parseFloat(e.getAttribute("height"))||t.height;return{offsetX:a/r*-s,offsetY:l/o*-i,scaleX:a/r,scaleY:l/o}}_drawPath(e,t){try{const n=t.getAttribute("d");if(!n)return!1;const s=window.getComputedStyle(t);e.strokeStyle=s.stroke||t.getAttribute("stroke")||"#666",e.lineWidth=parseFloat(s.strokeWidth||t.getAttribute("stroke-width"))||1,e.globalAlpha=parseFloat(s.opacity||t.getAttribute("opacity")||"1")*parseFloat(s.strokeOpacity||t.getAttribute("stroke-opacity")||"1"),this._applyDashArray(e,s,t),e.lineCap=s.strokeLinecap||"butt",e.lineJoin=s.strokeLinejoin||"miter",e.beginPath();const i=new Path2D(n);return e.stroke(i),!0}catch(e){return this._log("error","路径绘制失败",e),!1}}_applyDashArray(e,t,n){const s=t.strokeDasharray||n.getAttribute("stroke-dasharray");if(s&&"none"!==s){const t=s.split(/[\s,]+/).map(e=>parseFloat(e)).filter(e=>!isNaN(e));if(t.length>0)return void e.setLineDash(t)}e.setLineDash([])}_log(e,t,n=null){if(!this.config.DEBUG&&"info"===e)return;console[{info:"log",warn:"warn",error:"error"}[e]||"log"]("[SVGFixer]",t,n||"")}}},834:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"bottomright",draggable:!1!==e.draggable,storageKey:"legendPosition",dragThreshold:5,styles:e.styles,style:e.style||"gis"}),this.maxWidth=e.maxWidth||300,this.maxHeight=e.maxHeight||400,this.layers=e.layers||[]}getContainerClass(){return"leaflet-control-legend"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("legend")}getDefaultStyleName(){return"gis"}onStyleInit(e,t){t.style.maxWidth=this.maxWidth+"px",t.style.maxHeight=this.maxHeight+"px"}render(){if(!this.container)return;const e=this.getCurrentStyleObject();if(!e)return void console.warn(`图例样式 "${this.currentStyle}" 不存在`);const t=e.renderContainer(this.layers);this.container.innerHTML="",this.container.style.maxWidth=this.maxWidth+"px",this.container.style.maxHeight=this.maxHeight+"px";const n=document.createElement("div");n.className="legend-content",n.style.width="100%",n.style.height="100%",n.style.maxWidth="inherit",n.style.maxHeight="inherit",n.style.boxSizing="border-box",n.innerHTML=t,this.container.appendChild(n)}setLayers(e){this.layers=e||[],this.render()}addLayer(e){this.layers.push(e),this.render()}removeLayer(e){this.layers=this.layers.filter(t=>t.name!==e),this.render()}clearLayers(){this.layers=[],this.render()}update(){this.render()}setMaxWidth(e){this.maxWidth=e,this.container&&(this.container.style.maxWidth=e+"px")}setMaxHeight(e){this.maxHeight=e,this.container&&(this.container.style.maxHeight=e+"px")}getMaxWidth(){return this.maxWidth}getMaxHeight(){return this.maxHeight}getOptions(){return{maxWidth:this.maxWidth,maxHeight:this.maxHeight,layers:this.layers}}}L.Control.Legend=e,L.control.legend=function(e){return new L.Control.Legend(e).createControl()}},848:()=>{L.GISElements=L.GISElements||{},L.GISElements.StyleRegistry=L.GISElements.StyleRegistry||{},L.GISElements.StyleRegistry.register("map-info","professional",{id:"professional",name:"专业版",description:"标准GIS专题图样式，适合正式出版",render(e){const t=[];e.title&&t.push(`\n                <div class="lge-map-info-title">\n                    ${this._escapeHtml(e.title)}\n                </div>\n            `),e.subtitle&&t.push(`\n                <div class="lge-map-info-subtitle">\n                    ${this._escapeHtml(e.subtitle)}\n                </div>\n            `),(e.title||e.subtitle)&&t.push('<div class="lge-map-info-divider"></div>');const n=[];return e.author&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">制图者：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.author)}</span>\n            </div>`),e.organization&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">制图单位：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.organization)}</span>\n            </div>`),e.date&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">制图日期：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.date)}</span>\n            </div>`),e.dataSource&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">数据来源：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.dataSource)}</span>\n            </div>`),e.projection&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">坐标系统：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.projection)}</span>\n            </div>`),e.scale&&n.push(`<div class="lge-map-info-item">\n                <span class="lge-map-info-label">比例尺：</span>\n                <span class="lge-map-info-value">${this._escapeHtml(e.scale)}</span>\n            </div>`),n.length>0&&t.push(`\n                <div class="lge-map-info-metadata">\n                    ${n.join("")}\n                </div>\n            `),e.notes&&t.push(`\n                <div class="lge-map-info-notes">\n                    ${this._escapeHtml(e.notes)}\n                </div>\n            `),t.join("")},_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}})},865:()=>{!function(){"use strict";L.GISElements.StyleRegistry.register("graticule","dense",{name:"密集样式",meridian:{color:"#888",weight:.5,opacity:.3,dashArray:"2, 2"},parallel:{color:"#888",weight:.5,opacity:.3,dashArray:"2, 2"},frame:{color:"#444",weight:1,opacity:.6},label:{fontSize:10,fontFamily:"Arial, sans-serif",color:"#666"}})}()},917:()=>{L.GISElements=L.GISElements||{},L.GISElements.BaseControl=class{constructor(e={}){this.position=e.position||"topleft",this.draggable=!1!==e.draggable,this.storageKey=e.storageKey||"control-position",this.dragThreshold=e.dragThreshold||5,this.map=null,this.container=null,this.isDragging=!1,this.savedPosition=null,this._dragHandlers=null,this._loadSavedPosition()}createControl(){const e=this;return new(L.Control.extend({options:{position:e.position,control:e},onAdd:function(t){return e.map=t,e.container=e._createContainer(),e._initControl(),e.savedPosition&&e._applyRelativePosition(),e.draggable&&e._bindDragEvents(),L.DomEvent.disableClickPropagation(e.container),L.DomEvent.disableScrollPropagation(e.container),e.container},onRemove:function(t){e._cleanup()},setStyle:function(t){if("function"==typeof e.setStyle)return e.setStyle(t)},setMaxWidth:function(t){if("function"==typeof e.setMaxWidth)return e.setMaxWidth(t)},setMaxHeight:function(t){if("function"==typeof e.setMaxHeight)return e.setMaxHeight(t)},setSize:function(t){if("function"==typeof e.setSize)return e.setSize(t)},resetPosition:function(){if("function"==typeof e.resetPosition)return e.resetPosition()}}))}_createContainer(){const e=L.DomUtil.create("div",this.getContainerClass());return this.draggable&&(e.style.cursor="move"),e}_initControl(){this.onInit(this.map,this.container)}_loadSavedPosition(){this.savedPosition=L.GISElements.Storage.load(this.storageKey)}_applyRelativePosition(){this.container&&this.savedPosition&&this.map&&setTimeout(()=>{if(this.container.parentNode&&this.map){this._moveToMapContainer();const e=this.map.getContainer(),t=L.GISElements.Coordinate.relativeToAbsolute(this.savedPosition.ratioX,this.savedPosition.ratioY,e,this.container);this.container.style.position="absolute",this.container.style.left=t.x+"px",this.container.style.top=t.y+"px",this.container.style.zIndex="1000"}},0)}_moveToMapContainer(){if(!this.container||!this.map)return;const e=this.map.getContainer(),t=this.container.parentNode;t&&t!==e&&t.removeChild(this.container),this.container.parentNode!==e&&e.appendChild(this.container)}_bindDragEvents(){if(!this.container)return;let e,t,n,s,i=!1,r=!1;const o=o=>{if(0!==o.button)return;this.isDragging=!1,i=!1,e=o.clientX,t=o.clientY;const h=this.map.getContainer().getBoundingClientRect(),d=this.container.getBoundingClientRect();n=d.left-h.left,s=d.top-h.top,r="absolute"===this.container.style.position,document.addEventListener("mousemove",a),document.addEventListener("mouseup",l),this.onDragStart&&this.onDragStart(o)},a=o=>{const a=o.clientX-e,l=o.clientY-t;if(Math.abs(a)>this.dragThreshold||Math.abs(l)>this.dragThreshold){this.isDragging||(this.isDragging=!0,r||(this._moveToMapContainer(),this.container.style.position="absolute",this.container.style.left=n+"px",this.container.style.top=s+"px",this.container.style.zIndex="1000",r=!0),this.onDragBegin&&this.onDragBegin()),i=!0;const e=n+a,t=s+l,h=this.map.getContainer(),d=L.GISElements.Coordinate.constrainPosition(e,t,h,this.container);this.container.style.left=d.x+"px",this.container.style.top=d.y+"px",this.onDragging&&this.onDragging(d),o.preventDefault()}},l=e=>{if(this.isDragging&&i){const t=this.map.getContainer(),n=t.getBoundingClientRect(),s=this.container.getBoundingClientRect(),i={x:s.left-n.left,y:s.top-n.top},r=L.GISElements.Coordinate.absoluteToRelative(i.x,i.y,t);L.GISElements.Storage.save(this.storageKey,r),this.savedPosition=r,this.onDragEnd&&this.onDragEnd(i),e.preventDefault(),e.stopPropagation()}this.isDragging=!1,i=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};this.container.addEventListener("mousedown",o),this._dragHandlers={onMouseDown:o,onMouseMove:a,onMouseUp:l}}resetPosition(){if(this.container&&(this.container.style.position="",this.container.style.left="",this.container.style.top="",this.container.style.zIndex="",this.map)){const e=this.map.getContainer();if(this.container.parentNode===e){const t=this._findControlCorner();t&&(e.removeChild(this.container),t.appendChild(this.container))}}L.GISElements.Storage.remove(this.storageKey),this.savedPosition=null}_findControlCorner(){if(!this.map)return null;const e=this.position.match(/(top|bottom)(left|right)/);if(!e)return null;const t="leaflet-"+e[1],n="leaflet-"+e[2];return this.map.getContainer().querySelector(`.${t}.${n}`)}showContainer(){this.container&&(this.container.style.display="")}hideContainer(){this.container&&(this.container.style.display="none")}toggleContainer(){this.container&&("none"===this.container.style.display?this.showContainer():this.hideContainer())}isContainerVisible(){return!!this.container&&"none"!==this.container.style.display}_cleanup(){if(this._dragHandlers&&this.container){const{onMouseDown:e,onMouseMove:t,onMouseUp:n}=this._dragHandlers;this.container.removeEventListener("mousedown",e),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n),this._dragHandlers=null}this.onDestroy&&this.onDestroy(),this.map=null,this.container=null}getContainerClass(){throw new Error("子类必须实现 getContainerClass() 方法")}onInit(e,t){}onDestroy(){}onDragStart(e){}onDragBegin(){}onDragging(e){}onDragEnd(e){}}},949:()=>{L.GISElements.StyleRegistry.register("scale-bar","leaflet",{name:"Leaflet经典",render:e=>{const{width:t,label:n}=e;return`\n                <div class="lge-scale-bar-leaflet" style="width: ${t}px;">\n                    <div class="lge-scale-bar-label">${n}</div>\n                    <div class="lge-scale-bar-line">\n                        <div class="lge-scale-segment" style="width: 50%; background: #000;"></div>\n                        <div class="lge-scale-segment" style="width: 50%; background: #fff; border: 1px solid #000; border-left: none;"></div>\n                    </div>\n                </div>\n            `}})},994:()=>{L.GISElements=L.GISElements||{};class e extends L.GISElements.StylableControl{constructor(e={}){super({position:e.position||"topleft",draggable:!1,storageKey:"graticulePosition",style:e.style||"simple"}),this.interval=e.interval||null,this.lngInterval=e.lngInterval||null,this.latInterval=e.latInterval||null,this.showLabels=!1!==e.showLabels,this.labelPositions=e.labelPositions||{top:!0,bottom:!0,left:!0,right:!0},this.frameEnabled=!1!==e.frameEnabled,this.frameDraggable=!1!==e.frameDraggable,this.frameResizable=!1!==e.frameResizable;const t=this._loadFrameRect();this.frameRect=t||e.frameRect||{left:100,top:100,width:400,height:300},this.enabled=!1!==e.enabled,this.lines=[],this.labels=[],this.frame=null,this.frameDraggableManager=null,this.frameResizableManager=null}getContainerClass(){return"leaflet-control-graticule"}getDefaultStyles(){return L.GISElements.StyleRegistry.getStyles("graticule")}getDefaultStyleName(){return"simple"}onStyleInit(e,t){this._updateHandler=()=>this.updateGraticule(),e.on("move",this._updateHandler),e.on("zoom",this._updateHandler),this.enabled&&this.updateGraticule()}render(){this.updateGraticule()}updateGraticule(){this.map&&(this._clearLinesAndLabels(),this._clearFrame(),this.enabled&&this._drawGraticule())}_drawGraticule(){const e=this.getCurrentStyleObject();if(!e)return;const t=this.map.getZoom(),n=this.lngInterval||this._calculateInterval(t),s=this.latInterval||this._calculateInterval(t),i=this._getFrameLatLngBounds();this._drawMeridians(i,n,e.meridian),this._drawParallels(i,s,e.parallel),this.frameEnabled&&this._drawFrame(e.frame)}_redrawLinesOnly(){const e=this.getCurrentStyleObject();if(!e)return;const t=this.map.getZoom(),n=this.lngInterval||this._calculateInterval(t),s=this.latInterval||this._calculateInterval(t),i=this._getFrameLatLngBounds();this._drawMeridians(i,n,e.meridian),this._drawParallels(i,s,e.parallel)}_getFrameLatLngBounds(){if(!this.map)return this.map.getBounds();const e=this.map.containerPointToLatLng([this.frameRect.left,this.frameRect.top]),t=this.map.containerPointToLatLng([this.frameRect.left+this.frameRect.width,this.frameRect.top+this.frameRect.height]);return L.latLngBounds(t,e)}_drawMeridians(e,t,n){const s=e.getSouth(),i=e.getNorth(),r=e.getWest(),o=e.getEast();for(let e=Math.ceil(r/t)*t;e<=o;e+=t){const t={...n,className:"lge-graticule-line"},r=L.polyline([[s,e],[i,e]],t).addTo(this.map);if(this.lines.push(r),this.showLabels){const t=this.getCurrentStyleObject().label;this.labelPositions.top&&this._addLabel(e,i,this._formatLng(e),"longitude","top",t),this.labelPositions.bottom&&this._addLabel(e,s,this._formatLng(e),"longitude","bottom",t)}}}_drawParallels(e,t,n){const s=e.getSouth(),i=e.getNorth(),r=e.getWest(),o=e.getEast();for(let e=Math.ceil(s/t)*t;e<=i;e+=t){if(e<-90||e>90)continue;const t={...n,className:"lge-graticule-line"},s=L.polyline([[e,r],[e,o]],t).addTo(this.map);if(this.lines.push(s),this.showLabels){const t=this.getCurrentStyleObject().label;this.labelPositions.left&&this._addLabel(r,e,this._formatLat(e),"latitude","left",t),this.labelPositions.right&&this._addLabel(o,e,this._formatLat(e),"latitude","right",t)}}}_addLabel(e,t,n,s,i,r){const o=L.marker([t,e],{icon:L.divIcon({className:`lge-graticule-label lge-graticule-label-${s} lge-graticule-label-${i}`,html:`<span style="font-size: ${r.fontSize}px; font-family: ${r.fontFamily}; color: ${r.color};">${n}</span>`,iconSize:null}),interactive:!1,zIndexOffset:1e3}).addTo(this.map);this.labels.push(o)}_drawFrame(e){const t=L.GISElements.Constants?L.GISElements.Constants.Z_INDEX.GRATICULE_FRAME:400;this.frame=document.createElement("div"),this.frame.className="lge-graticule-frame",this.frame.style.cssText=`\n            position: absolute;\n            left: ${this.frameRect.left}px;\n            top: ${this.frameRect.top}px;\n            width: ${this.frameRect.width}px;\n            height: ${this.frameRect.height}px;\n            border: ${e.weight}px solid ${e.color};\n            opacity: ${e.opacity};\n            box-sizing: border-box;\n            pointer-events: auto;\n            z-index: ${t};\n        `,this.map.getContainer().appendChild(this.frame),this.frameDraggable&&L.GISElements.Draggable&&this._makeFrameDraggable(),this.frameResizable&&L.GISElements.Resizable&&this._makeFrameResizable(e.color)}_makeFrameDraggable(){let e=null;this.frameDraggableManager=new L.GISElements.Draggable(this.frame,{threshold:5,onDragStart:t=>{e={...this.frameRect},this.map.dragging&&this.map.dragging.disable(),this.frame.style.cursor="grabbing",this.frame.style.opacity="0.6",t.stopPropagation(),t.preventDefault()},onDragging:t=>{this.frameRect.left=e.left+t.x,this.frameRect.top=e.top+t.y,this.frame.style.left=this.frameRect.left+"px",this.frame.style.top=this.frameRect.top+"px",this.frameResizableManager&&this.frameResizableManager.updateHandlePositions(),this._clearLinesAndLabels(),this._redrawLinesOnly()},onDragEnd:()=>{this.frame.style.cursor="move";const e=this.getCurrentStyleObject().frame;this.frame.style.opacity=e.opacity,this.map.dragging&&this.map.dragging.enable(),this._saveFrameRect()}}),this.frameDraggableManager.enable(),this.frame.style.cursor="move"}_makeFrameResizable(e){const t=L.GISElements.Constants?L.GISElements.Constants.MIN_FRAME_WIDTH:100;this.frameResizableManager=new L.GISElements.Resizable(this.frame,{minWidth:t,minHeight:t,handleColor:e,onResizeStart:()=>{this.frame.style.opacity="0.6",this.map.dragging&&this.map.dragging.disable()},onResizing:()=>{this.frameRect.left=parseInt(this.frame.style.left)||0,this.frameRect.top=parseInt(this.frame.style.top)||0,this.frameRect.width=parseInt(this.frame.style.width)||this.frame.offsetWidth,this.frameRect.height=parseInt(this.frame.style.height)||this.frame.offsetHeight,this._clearLinesAndLabels(),this._redrawLinesOnly()},onResizeEnd:()=>{const e=this.getCurrentStyleObject().frame;this.frame.style.opacity=e.opacity,this.map.dragging&&this.map.dragging.enable(),this._saveFrameRect()},getBounds:()=>this.frameRect,setBounds:e=>{this.frameRect=e,this.frame.style.left=e.left+"px",this.frame.style.top=e.top+"px",this.frame.style.width=e.width+"px",this.frame.style.height=e.height+"px"}}),this.frameResizableManager.enable()}_clearLinesAndLabels(){this.lines.forEach(e=>{this.map&&this.map.removeLayer(e)}),this.lines=[],this.labels.forEach(e=>{this.map&&this.map.removeLayer(e)}),this.labels=[]}_clearFrame(){this.frameDraggableManager&&(this.frameDraggableManager.destroy(),this.frameDraggableManager=null),this.frameResizableManager&&(this.frameResizableManager.destroy(),this.frameResizableManager=null),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),this.frame=null}_calculateInterval(e){return e>=17?.001:e>=15?.005:e>=13?.01:e>=11?.05:e>=9?.1:e>=7?.5:e>=5?1:e>=3?5:10}_formatLng(e){const t=e>=0?"E":"W";return`${Math.abs(e).toFixed(3)}°${t}`}_formatLat(e){const t=e>=0?"N":"S";return`${Math.abs(e).toFixed(3)}°${t}`}_loadFrameRect(){try{const e=localStorage.getItem("graticuleFrameRect");if(!e)return null;const t=JSON.parse(e);return"number"==typeof t.left&&"number"==typeof t.top&&"number"==typeof t.width&&"number"==typeof t.height?t:null}catch(e){return console.warn("无法加载格网边框位置:",e),null}}_saveFrameRect(){try{localStorage.setItem("graticuleFrameRect",JSON.stringify(this.frameRect))}catch(e){console.warn("无法保存格网边框位置:",e)}}enable(){this.enabled=!0,this.updateGraticule()}disable(){this.enabled=!1,this._clearLinesAndLabels(),this._clearFrame()}toggle(){this.enabled?this.disable():this.enable()}enableFrame(){this.frameEnabled=!0,this.updateGraticule()}disableFrame(){this.frameEnabled=!1,this._clearFrame()}setInterval(e){this.interval=e,this.lngInterval=e,this.latInterval=e,this.updateGraticule()}setIntervals(e,t){this.lngInterval=e,this.latInterval=t,this.updateGraticule()}getLngInterval(){return this.lngInterval||this._calculateInterval(this.map?this.map.getZoom():0)}getLatInterval(){return this.latInterval||this._calculateInterval(this.map?this.map.getZoom():0)}setFrameRect(e){this.frameRect=e,this._saveFrameRect(),this.updateGraticule()}getFrameRect(){return this.frameRect}setLabelPositions(e){return this.labelPositions={...this.labelPositions,...e},this.enabled&&this.updateGraticule(),this}getLabelPositions(){return{...this.labelPositions}}resetFrameRect(){this.frameRect={left:100,top:100,width:400,height:300};try{localStorage.removeItem("graticuleFrameRect")}catch(e){console.warn("无法清除保存的格网边框位置:",e)}this.updateGraticule()}onDestroy(){this._updateHandler&&this.map&&(this.map.off("move",this._updateHandler),this.map.off("zoom",this._updateHandler)),this._clearLinesAndLabels(),this._clearFrame()}}L.Control.Graticule=e,L.control.graticule=function(e){return new L.Control.Graticule(e).createControl()}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};return(()=>{"use strict";n.d(s,{default:()=>e});n(283),n(85),n(564),n(247),n(469),n(17),n(917),n(162),n(142),n(45),n(750),n(277),n(600),n(532),n(12),n(49),n(949),n(285),n(359),n(391),n(558),n(84),n(278),n(865),n(848),n(370),n(420),n(470),n(294),n(834),n(994),n(94),n(566),n(183);L.GISElements=L.GISElements||{},Object.assign(L.GISElements,{version:"1.0.0",createController:function(e,t){if(!e)throw new Error("Map instance is required");return new this.MapController(e,t)},getAvailableStyles:function(e){return this.StyleRegistry.list(e)},configure:function(e){this.config=Object.assign({},this.config,e)},config:{debug:!1,autoSavePosition:!0,storagePrefix:"leaflet-gis-elements-"}}),console.log(`✓ Leaflet GIS Elements v${L.GISElements.version} 已加载`);const e=L.GISElements,{version:t,MapController:i,BaseControl:r,StylableControl:o,StyleRegistry:a,MapExporter:l,SVGFixer:h,BoundsCalculator:d,ExportConfig:c,Notification:g,Draggable:u,Resizable:p,createController:m,getAvailableStyles:f,configure:y,config:b}=L.GISElements})(),s=s.default})());
//# sourceMappingURL=leaflet-gis-elements.min.js.map